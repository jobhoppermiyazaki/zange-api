<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- APIãƒ™ãƒ¼ã‚¹URLã‚’ Render ç’°å¢ƒã«åˆã‚ã›ã¦å‹•çš„ã«æ±ºå®š -->
  <script>
    // Render ã®å…¬é–‹URLã‹ã‚‰å‘¼ã¶å ´åˆã¯ location.origin ã‚’åˆ©ç”¨
    // ä¾‹: https://zange-api.onrender.com/api/posts
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + "/api/posts";
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta charset="UTF-8">
  <title>zange- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</title>
  <link rel="stylesheet" href="style.css">
  <meta name="color-scheme" content="light">
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <section class="tutorial-section">
    <div class="tutorial-link card">
      <a href="about.html">ğŸ“• ã¯ã˜ã‚ã¦ã®æ–¹ã¯ã“ã¡ã‚‰</a>
    </div>
  </section>

  <div class="topics-strip">
    <div id="todayTopics" class="topics-row"></div>
  </div>

  <script>
    (function renderTopics(){
      const topics = ["ã¤ã„è²·ã£ã¦ã—ã¾ã£ãŸã‚‚ã®","ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«è¨€ãˆãªã‹ã£ãŸã“ã¨","ä»•äº‹ã§ã‚„ã‚‰ã‹ã—ãŸå°ã•ãªå¤±æ•—","é£Ÿæ¬²ã«è² ã‘ãŸç¬é–“","ãŠé‡‘ã®ä½¿ã„ã™ãåçœ"];
      const host = document.getElementById('todayTopics');
      host.innerHTML = '';
      topics.forEach(t => {
        const chip = document.createElement('div');
        chip.className = 'topic-chip';
        chip.innerHTML = `
          <span class="t-label">#${t}</span>
          <a class="t-post" href="post.html?topic=${encodeURIComponent(t)}">ğŸ™</a>
        `;
        host.appendChild(chip);
      });
    })();
  </script>

  <main class="container">
    <section class="card">
      <input type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã•ãŒã™ï¼ˆæœ¬æ–‡ãƒ»å¯¾è±¡ãƒ»ã‚¿ã‚°ï¼‰" />
    </section>
    <section id="timeline"></section>
  </main>

  <!-- æ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚ã£ã¦OKã€‚ä¸‹ã®æç”»ãŒæœ€å¾Œã«ä¸Šæ›¸ãã™ã‚‹ï¼‰ -->
  <script src="script.js"></script>

  <!-- çŠ¶æ…‹è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰CSSã§æ¶ˆã—ã¦OKï¼‰ -->
  <div id="apiStatus" style="position:sticky;top:0;z-index:9;font:12px/1.4 system-ui;background:#e7f5ff;border:1px solid #a5d8ff;padding:6px 8px;display:none"></div>

  <script>
    // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    const API_BASES = [
      window.ZANGE_API_BASE,                                      // â˜… å›ºå®šã®å…¬é–‹APIï¼ˆæœ€å„ªå…ˆï¼‰
      location.origin.replace(/\/+$/,'') + '/api/posts',
      'api/posts',
      '/api/posts'
    ].filter(Boolean);

    async function tryFetchJson(url, init){
      const u = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®ºã—
      const res = await fetch(u, Object.assign({ cache:'no-store', credentials:'same-origin' }, init||{}));
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function fetchJsonWithFallback(urls, init){
      let last;
      for (const u of urls){
        try { return await tryFetchJson(u, init); } catch(e){ last = e; }
      }
      throw last || new Error('fetch fail');
    }

    // ===== APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ =====
    const API = {
      async list(){
        const list = await fetchJsonWithFallback(API_BASES, { method:'GET' });
        list.sort((a,b)=> String(b.createdAt||b.created_at||b.date||'').localeCompare(String(a.createdAt||a.created_at||a.date||'')));
        return list;
      },
      async add(post){
        const payload = { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(post) };
        return await fetchJsonWithFallback(API_BASES, payload);
      }
    };

    // ===== localStorage äº’æ› =====
    function readLocal(){
      try{
        const arr = JSON.parse(localStorage.getItem('zange_posts') || '[]');
        if (!Array.isArray(arr)) return [];
        arr.sort((a,b)=> String(b.createdAt||b.created_at||b.date||'').localeCompare(String(a.createdAt||a.created_at||a.date||'')));
        return arr;
      }catch{ return []; }
    }

    async function migrateLocalToServerOnceIfNeeded(serverPosts){
      try{
        if ((serverPosts?.length||0) > 0) return;
        if (localStorage.getItem('zange_migrated') === '1') return;
        const local = readLocal();
        if (local.length === 0) return;
        for (const p of local){
          await API.add({ text: p.text || p.body || p.content || "", author: p.author || p.user || "" });
        }
        localStorage.setItem('zange_migrated','1');
      }catch(e){ console.warn('migrate skipped:', e.message); }
    }

    // ===== æç”» =====
    function render(posts){
      const wrap = document.getElementById('timeline');
      if (!wrap) return;
      wrap.innerHTML = '';
      posts.forEach(p=>{
        const text = escapeHTML(p.text || p.body || p.content || '');
        const author = escapeHTML(p.author || p.user || 'åŒ¿å');
        const when = formatDate(p.createdAt || p.created_at || p.date);
        const card = document.createElement('article');
        card.className = 'card zange-post';
        card.innerHTML = `
          <div class="post-body">${text.replace(/\n/g,'<br>')}</div>
          <div class="post-meta">
            <span class="post-author">by ${author}</span>
            ${when ? `<span class="post-date">ãƒ»${when}</span>` : ''}
            <button class="post-stamp-btn" type="button" data-id="${p.id || ''}" aria-label="ã‚¹ã‚¿ãƒ³ãƒ—ã™ã‚‹">ğŸ‘</button>
          </div>
        `;
        wrap.appendChild(card);
      });

      // ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å‰Šã‚‰ã‚Œã¦ã‚‚å¾©å…ƒï¼ˆè»½é‡ï¼‰
      const mo = new MutationObserver(()=> {
        if (!document.getElementById('timeline')?.children.length){
          render(posts);
        }
      });
      mo.observe(document.getElementById('timeline'), { childList:true });
    }

    // ===== ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆæœ€å¾Œã«å¼·åˆ¶ä¸Šæ›¸ãï¼‰=====
    async function refresh(){
      let posts = [];
      try{
        posts = await API.list();
        showApiStatus(`API OKï¼š${posts.length}ä»¶å–å¾—`, true);

        // ã‚µãƒ¼ãƒãŒç©ºãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä¸€åº¦ã ã‘ç§»è¡Œ
        await migrateLocalToServerOnceIfNeeded(posts);

        // å¿µã®ãŸã‚å†å–å¾—
        posts = await API.list();

        // ã‚µãƒ¼ãƒçµæœãŒã‚ã‚‹ã¨ãã ã‘ãƒ­ãƒ¼ã‚«ãƒ«ã¸åŒæœŸï¼ˆç©ºã§ä¸Šæ›¸ãã—ãªã„ï¼‰
        if (posts.length > 0){
          try{ localStorage.setItem('zange_posts', JSON.stringify(posts)); }catch{}
        }
      }catch(e){
        showApiStatus(`API NGï¼ˆ${e?.message || 'ã‚¨ãƒ©ãƒ¼'}ï¼‰ã€‚localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­â€¦`);
        posts = readLocal();
      }
      render(posts);
    }

    // DOM æº–å‚™å¾Œï¼†ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå¾Œã«â€œæœ€å¾Œã«â€ä¸Šæ›¸ã
    window.addEventListener('load', async ()=>{
      await refresh();
      setInterval(refresh, 8000);
    });
  </script>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">ğŸ </span><span class="label">ãƒ›ãƒ¼ãƒ </span></a>
      <a href="topics.html"><span class="icon">ğŸ¯</span><span class="label">ãŠé¡Œ</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">ğŸ””</span><span id="notifBadge" class="notif-badge" aria-label="æœªèª­é€šçŸ¥æ•°"></span></span>
        <span class="label">é€šçŸ¥</span>
      </a>
      <a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">è¨­å®š</span></a>
      <a href="about.html"><span class="icon">ğŸ“•</span><span class="label">æ¦‚è¦</span></a>
    </nav>
  </footer>

  <a class="fab" href="post.html"><span class="emoji">ğŸ™</span></a>

  <footer>&copy; 2025 zange (ãƒ†ã‚¹ãƒˆå…¬é–‹ä¸­)</footer>

  <div id="stampModalBackdrop" class="stamp-modal-backdrop" aria-hidden="true">
    <div class="stamp-modal" role="dialog" aria-modal="true" aria-labelledby="stampModalTitle">
      <h3 id="stampModalTitle">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã¶</h3>
      <div id="stampGrid" class="stamp-grid"></div>
      <div class="row-end"><button type="button" class="btn-close" onclick="closeStampPicker()">é–‰ã˜ã‚‹</button></div>
    </div>
  </div>
</body>
</html>