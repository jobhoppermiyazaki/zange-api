<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Renderã®APIã‚’ä½¿ã† -->
  <script>window.ZANGE_API_BASE = "https://zange-api.onrender.com/api/posts";</script>
  <meta charset="UTF-8" />
  <title>zange - æŠ•ç¨¿ã™ã‚‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />
  <style>
    .bg-picker { display:flex; flex-wrap:wrap; gap:12px; }
    .bg-thumb{
      width:96px; height:96px; border-radius:14px;
      border:2px solid #eee; background:#fff center/cover no-repeat;
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow:0 1px 4px rgba(0,0,0,.06); cursor:pointer;
    }
    .bg-thumb.selected{ border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.2); }
    .bg-thumb.bg-none{
      font-weight:700; color:#6b7280;
      background:repeating-linear-gradient(45deg,#f9fafb,#f9fafb 10px,#f3f4f6 10px,#f3f4f6 20px);
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main>
    <form id="postForm">
      <label>æŠ•ç¨¿å†…å®¹</label>
      <textarea id="zangeText" rows="4" placeholder="ä¾‹ï¼‰å¸°å®…ã¯ãƒã‚¹ã£ã¦è¨€ã£ãŸã‘ã©ã€å®Ÿã¯ã‚¿ã‚¯ã‚·ãƒ¼ä½¿ã£ã¡ã‚ƒã£ãŸâ€¦"></textarea>

      <label>èª°ã«ï¼ˆå¿…é ˆï¼‰</label>
      <select id="zangeTargetFixed">
        <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="è‡ªåˆ†">è‡ªåˆ†</option>
        <option value="è¦ªå‹">è¦ªå‹</option>
        <option value="å‹é”">å‹é”</option>
        <option value="å½¼å¥³ãƒ»å½¼æ°">å½¼å¥³ãƒ»å½¼æ°</option>
        <option value="å¦»">å¦»</option>
        <option value="å¤«">å¤«</option>
        <option value="ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</option>
        <option value="çˆ¶">çˆ¶</option>
        <option value="æ¯">æ¯</option>
        <option value="ç¥–çˆ¶æ¯">ç¥–çˆ¶æ¯</option>
        <option value="å…ˆç”Ÿ">å…ˆç”Ÿ</option>
        <option value="ä¸Šå¸">ä¸Šå¸</option>
        <option value="å…ˆè¼©">å…ˆè¼©</option>
        <option value="å¾Œè¼©">å¾Œè¼©</option>
        <option value="éƒ¨ä¸‹">éƒ¨ä¸‹</option>
      </select>

      <label>ã‚¿ã‚°ï¼ˆä»»æ„ï¼‰</label>
      <input type="text" id="futureTag" placeholder="ä¾‹ï¼‰#ç¯€ç´„ã—ã¾ã™ / #æ˜æ—¥ã¯æˆ‘æ…¢ã™ã‚‹">

      <label>èƒŒæ™¯ç”»åƒã‚’é¸æŠ</label>
      <input type="hidden" id="zangeBg" value="">
      <div class="bg-picker" id="bgPicker">
        <!-- ãªã—ï¼ˆåˆæœŸé¸æŠæ‰±ã„ï¼‰ -->
        <button type="button" class="bg-thumb bg-none selected" data-bg="" aria-label="èƒŒæ™¯ãªã—">ãªã—</button>

        <!-- æ—¢å­˜ -->
        <button type="button" class="bg-thumb" data-bg="bg1.jpg" style="background-image:url('images/bg1.jpg')" aria-label="èƒŒæ™¯1"></button>
        <button type="button" class="bg-thumb" data-bg="bg2.jpg" style="background-image:url('images/bg2.jpg')" aria-label="èƒŒæ™¯2"></button>
        <button type="button" class="bg-thumb" data-bg="bg3.jpg" style="background-image:url('images/bg3.jpg')" aria-label="èƒŒæ™¯3"></button>
        <button type="button" class="bg-thumb" data-bg="bg4.jpg" style="background-image:url('images/bg4.jpg')" aria-label="èƒŒæ™¯4"></button>
        <button type="button" class="bg-thumb" data-bg="bg5.jpg" style="background-image:url('images/bg5.jpg')" aria-label="èƒŒæ™¯5"></button>

        <!-- è¿½åŠ  -->
        <button type="button" class="bg-thumb" data-bg="bg6.jpg" style="background-image:url('images/bg6.jpg')" aria-label="èƒŒæ™¯6"></button>
        <button type="button" class="bg-thumb" data-bg="bg7.jpg" style="background-image:url('images/bg7.jpg')" aria-label="èƒŒæ™¯7"></button>
        <button type="button" class="bg-thumb" data-bg="bg8.jpg" style="background-image:url('images/bg8.jpg')" aria-label="èƒŒæ™¯8"></button>
      </div>

      <label>å…¬é–‹ç¯„å›²</label>
      <div style="display:flex; gap:12px; align-items:center;">
        <label><input type="radio" name="scope" value="public" checked> å…¨ä½“å…¬é–‹</label>
        <label><input type="radio" name="scope" value="private"> éå…¬é–‹ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰</label>
      </div>

      <div style="margin-top:14px;">
        <button id="submitBtn" type="submit">æŠ•ç¨¿ã™ã‚‹</button>
      </div>
    </form>
  </main>

  <script>
    // ====== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆé…åˆ—ï¼ˆå›ºå®šURLâ†’çµ¶å¯¾â†’ç›¸å¯¾â†’ãƒ«ãƒ¼ãƒˆï¼‰ ======
    const API_ENDPOINTS = [
      window.ZANGE_API_BASE,
      location.origin.replace(/\/+$/,'') + '/api/posts',
      'api/posts',
      '/api/posts'
    ].filter(Boolean);

    async function postJsonWithFallback(data){
      let lastErr;
      for (const url of API_ENDPOINTS){
        try{
          const u = url + (url.includes('?')?'&':'?') + '_t=' + Date.now(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ®ºã—
          const res = await fetch(u, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(data),
            cache:'no-store',
            // åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãªã‚‰ same-originã€åˆ¥ã‚ªãƒªã‚¸ãƒ³ï¼ˆCORSï¼‰ãªã‚‰ omit
            credentials: url.startsWith(location.origin) ? 'same-origin' : 'omit'
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('API error');
    }

    // localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆindexã®ãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºã¨äº’æ›ï¼‰
    function saveLocalFallback(post) {
      try {
        const key = 'zange_posts';
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        const maxId = arr.reduce((m, p) => Math.max(m, Number(p.id||0)), 0) || 0;
        arr.push({
          id: maxId + 1,
          text: post.text || "",
          author: post.author || "åŒ¿å",
          createdAt: new Date().toISOString(),
          target: post.target || "",
          tag: post.tag || "",
          bg: post.bg || "",
          scope: post.scope || "public"
        });
        localStorage.setItem(key, JSON.stringify(arr));
      } catch(e) { console.warn('local fallback failed:', e); }
    }

    // èƒŒæ™¯ã‚µãƒ ãƒé¸æŠï¼ˆä»•æ§˜ç¶­æŒï¼‰
    (function setupBgPicker(){
      const picker = document.getElementById('bgPicker');
      const hidden = document.getElementById('zangeBg');
      if (!picker || !hidden) return;
      picker.addEventListener('click', (e)=>{
        const btn = e.target.closest('.bg-thumb');
        if (!btn) return;
        picker.querySelectorAll('.bg-thumb').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        hidden.value = btn.getAttribute('data-bg') || '';
      });
    })();

    // é€ä¿¡ï¼ˆAPIå„ªå…ˆâ†’å¤±æ•—æ™‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜â†’indexã¸æˆ»ã‚‹ï¼‰
    (function setupSubmit(){
      const form = document.getElementById('postForm');
      const submitBtn = document.getElementById('submitBtn');
      if (!form) return;

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = (document.getElementById('zangeText')?.value || '').trim();
        const target = (document.getElementById('zangeTargetFixed')?.value || '').trim();
        const tag = (document.getElementById('futureTag')?.value || '').trim();
        const bg = (document.getElementById('zangeBg')?.value || '').trim();
        const scope = (document.querySelector('input[name="scope"]:checked')?.value || 'public').trim();

        if (!text){ alert('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (!target){ alert('ã€Œèª°ã«ã€ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

        const author = ''; // ä»•æ§˜ä¸Šã€æœªæŒ‡å®šã®ã¾ã¾ï¼ˆå¿…è¦ã«ãªã‚Œã°ã“ã“ã«åæ˜ ï¼‰
        const payload = { text, author, target, tag, bg, scope };

        const originalLabel = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'æŠ•ç¨¿ä¸­â€¦';

        try{
          await postJsonWithFallback(payload);
        }catch(e){
          console.warn('API save failed, fallback to localStorage:', e?.message || e);
          saveLocalFallback(payload);
        }finally{
          submitBtn.disabled = false;
          submitBtn.textContent = originalLabel;
        }

        location.href = 'index.html';
      });
    })();
  </script>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆ5ã‚¿ãƒ–ä»•æ§˜ï¼‰ï¼‹FABã¯ç¾çŠ¶ç¶­æŒ -->
  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">ğŸ </span><span class="label">ãƒ›ãƒ¼ãƒ </span></a>
      <a href="topics.html"><span class="icon">ğŸ¯</span><span class="label">ãŠé¡Œ</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">ğŸ””</span><span id="notifBadge" class="notif-badge" aria-label="æœªèª­é€šçŸ¥æ•°"></span></span>
        <span class="label">é€šçŸ¥</span>
      </a>
      <a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">è¨­å®š</span></a>
      <a href="about.html"><span class="icon">ğŸ“•</span><span class="label">æ¦‚è¦</span></a>
    </nav>
  </footer>

  <footer>&copy; 2025 zange (ãƒ†ã‚¹ãƒˆå…¬é–‹ä¸­)</footer>

  <script src="script.js"></script>
</body>
</html>