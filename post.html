<!DOCTYPE html>
<html lang="ja">
<head>
  <script>
    window.ZANGE_API_BASES = [
      location.origin.replace(/\/+$/,'') + '/api/posts',
      'api/posts',
      '/api/posts'
    ];
  </script>
  <meta charset="UTF-8" />
  <title>zange - 投稿する</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />
  <style>
    .bg-picker { display:flex; flex-wrap:wrap; gap:12px; }
    .bg-thumb{ width:96px; height:96px; border-radius:14px; border:2px solid #eee; background:#fff center/cover no-repeat; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 1px 4px rgba(0,0,0,.06); cursor:pointer; }
    .bg-thumb.selected{ border-color:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.2); }
    .bg-thumb.bg-none{ font-weight:700; color:#6b7280; background:repeating-linear-gradient(45deg,#f9fafb,#f9fafb 10px,#f3f4f6 10px,#f3f4f6 20px); }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main>
    <form id="postForm" autocomplete="off">
      <label>投稿内容</label>
      <textarea id="zangeText" rows="4" required placeholder="例）帰宅はバスって言ったけど、実はタクシー使っちゃった…"></textarea>

      <label>誰に（必須）</label>
      <select id="zangeTargetFixed" required>
        <option value="" selected>選択してください</option>
        <option>自分</option><option>親友</option><option>友達</option><option>彼女・彼氏</option>
        <option>妻</option><option>夫</option><option>パートナー</option><option>父</option>
        <option>母</option><option>祖父母</option><option>先生</option><option>上司</option>
        <option>先輩</option><option>後輩</option><option>部下</option>
      </select>

      <label>タグ（任意）</label>
      <input type="text" id="futureTag" placeholder="例）#節約します / #明日は我慢する">

      <label>背景画像を選択</label>
      <input type="hidden" id="zangeBg" value="">
      <div class="bg-picker" id="bgPicker">
        <button type="button" class="bg-thumb bg-none selected" data-bg="">なし</button>
        <button type="button" class="bg-thumb" data-bg="bg1.jpg" style="background-image:url('images/bg1.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg2.jpg" style="background-image:url('images/bg2.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg3.jpg" style="background-image:url('images/bg3.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg4.jpg" style="background-image:url('images/bg4.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg5.jpg" style="background-image:url('images/bg5.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg6.jpg" style="background-image:url('images/bg6.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg7.jpg" style="background-image:url('images/bg7.jpg')"></button>
        <button type="button" class="bg-thumb" data-bg="bg8.jpg" style="background-image:url('images/bg8.jpg')"></button>
      </div>

      <label>公開範囲</label>
      <div style="display:flex; gap:12px; align-items:center;">
        <label><input type="radio" name="scope" value="public" checked> 全体公開</label>
        <label><input type="radio" name="scope" value="private"> 非公開（自分のみ）</label>
      </div>

      <div style="margin-top:14px;">
        <button id="submitBtn" type="submit">投稿する</button>
      </div>
    </form>
  </main>

  <script>
    function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    async function postJson(data){
      let last;
      for (const base of window.ZANGE_API_BASES){
        try{
          const u = base + (base.includes('?')?'&':'?') + '_t='+Date.now();
          const res = await fetch(u, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(data),
            cache:'no-store',
            credentials:'include'   // セッション送信
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ last=e; }
      }
      throw last || new Error('API error');
    }

    (function setupBgPicker(){
      const picker = document.getElementById('bgPicker');
      const hidden = document.getElementById('zangeBg');
      picker.addEventListener('click', (e)=>{
        const btn = e.target.closest('.bg-thumb'); if (!btn) return;
        picker.querySelectorAll('.bg-thumb').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected'); hidden.value = btn.getAttribute('data-bg') || '';
      });
    })();

    (function setupSubmit(){
      const form = document.getElementById('postForm');
      const submitBtn = document.getElementById('submitBtn');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = (document.getElementById('zangeText')?.value || '').trim();
        const target = (document.getElementById('zangeTargetFixed')?.value || '').trim();
        const tag = (document.getElementById('futureTag')?.value || '').trim();
        const bg = (document.getElementById('zangeBg')?.value || '').trim();
        const scope = (document.querySelector('input[name="scope"]:checked')?.value || 'public').trim();

        if (!text){ alert('投稿内容を入力してください'); return; }
        if (!target){ alert('「誰に」を選択してください'); return; }

        submitBtn.disabled = true; const original = submitBtn.textContent; submitBtn.textContent = '投稿中…';
        try{
          await postJson({ text, target, tag, bg, scope });   // author はサーバで決定
          location.href = 'index.html';
        }catch(e){
          alert('投稿に失敗しました。通信環境をご確認のうえ、もう一度お試しください。\\n詳細: ' + (e?.message||e));
        }finally{
          submitBtn.disabled = false; submitBtn.textContent = original;
        }
      });
    })();

    // ユーザー表示（ログアウトボタンは出さない）
    async function renderUserIcon() {
      const box = document.getElementById("currentUserIcon");
      try {
        const res = await fetch("/api/me", { credentials:"include", cache:"no-store" });
        const data = await res.json();
        box.innerHTML = (data.ok && data.user)
          ? `<span class="pill" style="padding:6px 10px;border-radius:999px;background:#f1f5f9;">👤 ${escapeHTML(data.user.nickname || data.user.email)}</span>`
          : `<a href="login.html">ログイン</a>`;
      } catch { box.innerHTML = `<a href="login.html">ログイン</a>`; }
    }
    document.addEventListener("DOMContentLoaded", renderUserIcon);
  </script>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">🏠</span><span class="label">ホーム</span></a>
      <a href="topics.html"><span class="icon">🎯</span><span class="label">お題</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">🔔</span><span id="notifBadge" class="notif-badge" aria-label="未読通知数"></span></span>
        <span class="label">通知</span>
      </a>
      <a href="settings.html"><span class="icon">⚙️</span><span class="label">設定</span></a>
      <a href="about.html"><span class="icon">📕</span><span class="label">概要</span></a>
    </nav>
  </footer>
  <footer>&copy; 2025 zange (テスト公開中)</footer>
  <script src="script.js"></script>
</body>
</html>
