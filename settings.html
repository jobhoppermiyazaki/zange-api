<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />

  <!-- Render ã®åŒä¸€ã‚ªãƒªã‚¸ãƒ³ API ã‚’æœ€å„ªå…ˆã«ä½¿ã† -->
  <script>
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + '/api/posts';
  </script>

  <style>
    /* --- Settings page quick styles --- */
    .section-title{font-weight:800;font-size:18px;margin:8px 0 6px;}
    .card.form{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .avatar{
      width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--panel-border,#eee);
      background:#f6f6f6;display:block
    }
    .avatar-wrap{display:flex;flex-direction:column;gap:6px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .field input[type="text"], .field input[type="number"], .field textarea, .field select{width:100%}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;box-shadow:var(--shadow);cursor:pointer}
    .btn.danger{background:#ffecec;border-color:#ffc9c9}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    .muted{color:#8a8a8a}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9}

    .my-post .edit-area{margin-top:8px;display:none !important;}
    .my-post.editing .edit-area{display:block !important;}

    #profileView p{margin:2px 0}
    #profileView .name{font-weight:700;font-size:16px}
    #profileView .meta{font-size:13px;color:#6b7280}
    #profileView .bio{margin-top:4px}

    .follow-posts-modal{
      position:fixed; inset:0; display:none; z-index:9999;
      background:rgba(0,0,0,.35); padding:16px;
      align-items:flex-end; justify-content:center;
    }
    .follow-posts-modal .sheet{
      width:100%; max-width:720px; max-height:80vh; overflow:auto;
      background:#fff; border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .follow-posts-modal .sheet .head{
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
    }
    .follow-posts-modal .close-btn{ padding:8px 12px; border:1px solid #eee; border-radius:10px; background:#fff; }
    .follow-link{ border:none; background:none; padding:0; font:inherit; color:inherit; text-align:left; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main style="padding-bottom:90px">
    <!-- è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‹ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div class="card form">

      <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
      <div id="profileView">
        <div class="row">
          <div class="avatar-wrap">
            <!-- ç”»åƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
            <img id="profileAvatarShow" class="avatar" src="images/default-avatar.png" alt="avatar"
                 onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;84&quot; height=&quot;84&quot; viewBox=&quot;0 0 84 84&quot;><circle cx=&quot;42&quot; cy=&quot;42&quot; r=&quot;42&quot; fill=&quot;%23f1f5f9&quot;/><circle cx=&quot;42&quot; cy=&quot;34&quot; r=&quot;14&quot; fill=&quot;%23cbd5e1&quot;/><rect x=&quot;16&quot; y=&quot;52&quot; width=&quot;52&quot; height=&quot;20&quot; rx=&quot;10&quot; fill=&quot;%23cbd5e1&quot;/></svg>';">
          </div>
          <div class="field" style="min-width:180px;flex:2">
            <p id="profileNameShow" class="name">åŒ¿å</p>
            <p id="profileGenderShow" class="meta">æ€§åˆ¥: â€”</p>
            <p id="profileAgeShow" class="meta">å¹´é½¢: â€”</p>
            <p id="profileBioShow" class="bio">è‡ªå·±ç´¹ä»‹: â€”</p>
          </div>
          <div class="right">
            <button id="editProfileBtn" class="btn">ç·¨é›†</button>
          </div>
        </div>
      </div>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
      <div id="profileEdit" style="display:none;">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarPreview" class="avatar" src="images/default-avatar.png" alt="avatar"
                 onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;84&quot; height=&quot;84&quot; viewBox=&quot;0 0 84 84&quot;><circle cx=&quot;42&quot; cy=&quot;42&quot; r=&quot;42&quot; fill=&quot;%23f1f5f9&quot;/><circle cx=&quot;42&quot; cy=&quot;34&quot; r=&quot;14&quot; fill=&quot;%23cbd5e1&quot;/><rect x=&quot;16&quot; y=&quot;52&quot; width=&quot;52&quot; height=&quot;20&quot; rx=&quot;10&quot; fill=&quot;%23cbd5e1&quot;/></svg>';">
            <label class="btn">
              ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒè¨­å®š
              <input id="profileAvatarInput" type="file" accept="image/*" style="display:none">
            </label>
          </div>
          <div class="field">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
            <input id="profileNickname" type="text" placeholder="ä¾‹ï¼‰zangeå¤ªéƒ">
          </div>
          <div class="field" style="max-width:140px">
            <label>æ€§åˆ¥</label>
            <select id="profileGender">
              <option value="">æœªé¸æŠ</option>
              <option>ç”·æ€§</option>
              <option>å¥³æ€§</option>
              <option>ãã®ä»–</option>
              <option>å›ç­”ã—ãªã„</option>
            </select>
          </div>
          <div class="field" style="max-width:140px">
            <label>å¹´é½¢</label>
            <select id="profileAge">
              <option value="">æœªé¸æŠ</option>
              <option>ã€œ19</option><option>20-24</option><option>25-29</option>
              <option>30-34</option><option>35-39</option><option>40-44</option>
              <option>45-49</option><option>50-59</option><option>60+</option>
            </select>
          </div>
          <div class="field" style="flex-basis:100%">
            <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
            <textarea id="profileBio" rows="3" placeholder="ã²ã¨ã“ã¨è‡ªå·±ç´¹ä»‹"></textarea>
          </div>
        </div>
        <div class="btn-row">
          <button id="profileSaveBtn" class="btn primary">ä¿å­˜</button>
          <button id="profileCancelBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ -->
    <section class="card">
      <div class="follow-tabs">
        <div class="tabbar" role="tablist" aria-label="follow tabs">
          <button id="tab-followers" class="tab2" role="tab"
                  aria-selected="false" aria-controls="pane-followers">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</button>
          <button id="tab-following" class="tab2 active" role="tab"
                  aria-selected="true" aria-controls="pane-following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
          <span class="tab-underline" aria-hidden="true"></span>
        </div>

        <div id="followStats" class="follow-stats under"></div>

        <div id="pane-following" class="tabpanel show" role="tabpanel" aria-labelledby="tab-following">
          <div id="followingList"></div>
        </div>

        <div id="pane-followers" class="tabpanel" role="tabpanel" aria-labelledby="tab-followers" hidden>
          <div id="followersList"></div>
        </div>
      </div>
    </section>

    <!-- è‡ªåˆ†ã®æŠ•ç¨¿ -->
    <div class="card form" style="margin-top:16px">
      <div class="section-title">è‡ªåˆ†ã®æŠ•ç¨¿</div>
      <div class="my-posts-toolbar">
        <input id="myPostsSearch"
               type="search"
               inputmode="search"
               placeholder="è‡ªåˆ†ã®æŠ•ç¨¿ã‚’æ¤œç´¢ï¼ˆæœ¬æ–‡ãƒ»å¯¾è±¡ãƒ»ã‚¿ã‚°ï¼‰">
      </div>
      <div id="myPostsList"></div>
    </div>

    <!-- â–¼ ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« â–¼ -->
    <div id="followPostsModal" class="follow-posts-modal">
      <div class="sheet card">
        <div class="head">
          <strong id="followPostsTitle">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿</strong>
          <button id="followPostsClose" class="close-btn">é–‰ã˜ã‚‹</button>
        </div>
        <div id="followPostsList"></div>
      </div>
    </div>
  </main>

  <!-- æ—¢å­˜ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">ğŸ </span><span class="label">ãƒ›ãƒ¼ãƒ </span></a>
      <a href="topics.html"><span class="icon">ğŸ¯</span><span class="label">ãŠé¡Œ</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">ğŸ””</span><span id="notifBadge" class="notif-badge" aria-label="æœªèª­é€šçŸ¥æ•°"></span></span>
        <span class="label">é€šçŸ¥</span>
      </a>
      <a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">è¨­å®š</span></a>
      <a href="about.html"><span class="icon">ğŸ“•</span><span class="label">æ¦‚è¦</span></a>
    </nav>
  </footer>

  <a class="fab" href="post.html"><span class="emoji">ğŸ™</span></a>

  <script src="script.js"></script>

  <!-- â–¼ è¿½åŠ ï¼šãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®è¡¨ç¤ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å³ä¸Šï¼‰ï¼‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åã®åˆæœŸåŒ– â–¼ -->
  <script>
    async function renderUserIcon(){
      const box = document.getElementById("currentUserIcon");
      if (!box) return;
      try{
        const res = await fetch("/api/me",{ credentials:"include", cache:"no-store" });
        const data = await res.json();
        if (data.ok && data.user){
          const esc = s => (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
          const name = data.user.nickname || data.user.email;
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
          box.innerHTML = `
            <span style="display:inline-flex;align-items:center;gap:8px;">
              <span class="pill" style="padding:6px 10px;border-radius:999px;background:#f1f5f9;">ğŸ‘¤ ${esc(name)}</span>
              <button id="logoutBtn" style="padding:6px 10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </span>`;
          document.getElementById("logoutBtn")?.addEventListener("click", async()=>{
            await fetch("/api/logout",{ method:"POST", credentials:"include" });
            location.reload();
          });

          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºæ¬„ã®åå‰ã‚‚åˆæœŸåŒ–ï¼ˆä»»æ„ï¼‰
          const nameShow = document.getElementById('profileNameShow');
          if (nameShow && nameShow.textContent.trim() === 'åŒ¿å') {
            nameShow.textContent = name;
          }
          // ç·¨é›†æ¬„ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ åˆæœŸå€¤ã‚‚ï¼ˆæœªå…¥åŠ›ãªã‚‰ï¼‰
          const nameInput = document.getElementById('profileNickname');
          if (nameInput && !nameInput.value) {
            nameInput.value = data.user.nickname || '';
          }
        }else{
          box.innerHTML = `<a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>`;
        }
      }catch{
        box.innerHTML = `<a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>`;
      }
    }
    document.addEventListener("DOMContentLoaded", renderUserIcon);
  </script>

  <footer>&copy; 2025 zange (ãƒ†ã‚¹ãƒˆå…¬é–‹ä¸­)</footer>
</body>
</html>
