<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - マイページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />

  <script>
    /* Render の同一オリジン API を最優先に使う（既存） */
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + '/api/posts';
  </script>

  <style>
    .section-title{font-weight:800;font-size:18px;margin:8px 0 6px;}
    .card.form{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--panel-border,#eee);background:#f6f6f6;display:block}
    .avatar-wrap{display:flex;flex-direction:column;gap:6px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .field input[type="text"], .field input[type="number"], .field textarea, .field select{width:100%}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;box-shadow:var(--shadow);cursor:pointer}
    .btn.danger{background:#ffecec;border-color:#ffc9c9}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    .muted{color:#8a8a8a}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9}
    .my-post .edit-area{margin-top:8px;display:none !important;}
    .my-post.editing .edit-area{display:block !important;}
    #profileView p{margin:2px 0}
    #profileView .name{font-weight:700;font-size:16px}
    #profileView .meta{font-size:13px;color:#6b7280}
    #profileView .bio{margin-top:4px}
    .follow-posts-modal{position:fixed; inset:0; display:none; z-index:9999; background:rgba(0,0,0,.35); padding:16px; align-items:flex-end; justify-content:center;}
    .follow-posts-modal .sheet{width:100%; max-width:720px; max-height:80vh; overflow:auto; background:#fff; border-radius:16px; padding:12px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .follow-posts-modal .sheet .head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;}
    .follow-posts-modal .close-btn{ padding:8px 12px; border:1px solid #eee; border-radius:10px; background:#fff; }
    .follow-link{ border:none; background:none; padding:0; font:inherit; color:inherit; text-align:left; cursor:pointer; }

    /* --- フォロー一覧をタブの「下」に縦積み表示させる強制レイアウト --- */
    .follow-tabs{ 
      display:block !important;
      align-items:unset !important;
      justify-content:unset !important;
    }
    .follow-tabs .tabbar{
      display:flex !important;
      gap:12px;
      align-items:center;
      margin-bottom:8px;
      position:relative;
    }
    .follow-tabs .tab-underline{
      position:absolute;
      bottom:-2px;
      left:0;
      height:2px;
      width:50%;
    }
    .follow-tabs .tabpanel{
      display:block !important;
      width:100% !important;
      clear:both !important;
      margin-top:6px;
    }
    .follow-tabs .follow-stats.under{
      display:block !important;
      margin:6px 0 10px;
      clear:both !important;
    }
    #followingList, #followersList{ display:block !important; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main style="padding-bottom:90px">
    <!-- 自分のプロフィール -->
    <div class="card form">
      <div id="profileView">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarShow" class="avatar" src="images/default-avatar.png" alt="avatar"
                 onerror="this.onerror=null;this.src='images/default-avatar.png';">
          </div>
          <div class="field" style="min-width:180px;flex:2">
            <p id="profileNameShow" class="name">匿名</p>
            <p id="profileGenderShow" class="meta">性別: —</p>
            <p id="profileAgeShow" class="meta">年齢: —</p>
            <p id="profileBioShow" class="bio">自己紹介: —</p>
          </div>
          <div class="right"><button id="editProfileBtn" class="btn">編集</button></div>
        </div>
      </div>
    </div>

    <!-- フォロー・フォロワー -->
    <section class="card">
      <div class="follow-tabs">
        <div class="tabbar" role="tablist" aria-label="follow tabs">
          <button id="tab-followers" class="tab2" role="tab"
                  aria-selected="false" aria-controls="pane-followers">フォロワー</button>
          <button id="tab-following" class="tab2 active" role="tab"
                  aria-selected="true" aria-controls="pane-following">フォロー中</button>
          <span class="tab-underline" aria-hidden="true"></span>
        </div>
        <div id="followStats" class="follow-stats under"></div>
        <div id="pane-following" class="tabpanel show" role="tabpanel" aria-labelledby="tab-following">
          <div id="followingList"></div>
        </div>
        <div id="pane-followers" class="tabpanel" role="tabpanel" aria-labelledby="tab-followers" hidden>
          <div id="followersList"></div>
        </div>
      </div>
    </section>

    <!-- 自分の投稿 -->
    <div class="card form" style="margin-top:16px">
      <div class="section-title">自分の投稿</div>
      <div class="my-posts-toolbar">
        <input id="myPostsSearch" type="search" inputmode="search" placeholder="自分の投稿を検索（本文・対象・タグ）">
      </div>
      <div id="myPostsList"></div>
    </div>
  </main>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">🏠</span><span class="label">ホーム</span></a>
      <a href="topics.html"><span class="icon">🎯</span><span class="label">お題</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">🔔</span><span id="notifBadge" class="notif-badge"></span></span>
        <span class="label">通知</span>
      </a>
      <a href="settings.html"><span class="icon">⚙️</span><span class="label">設定</span></a>
      <a href="about.html"><span class="icon">📕</span><span class="label">概要</span></a>
    </nav>
  </footer>
  <a class="fab" href="post.html"><span class="emoji">🙏</span></a>

  <script src="script.js"></script>
  <script>
    async function renderUserIcon(){
      const box=document.getElementById("currentUserIcon");
      if(!box)return;
      try{
        const res=await fetch("/api/me",{credentials:"include",cache:"no-store"});
        const data=await res.json();
        if(data.ok&&data.user){
          const esc=s=>(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
          const name=data.user.nickname||data.user.email;
          box.innerHTML=`<span class="pill">👤 ${esc(name)}</span>`;
        }else{box.innerHTML=`<a href="login.html">ログイン</a>`;}
      }catch{box.innerHTML=`<a href="login.html">ログイン</a>`;}
    }

    document.addEventListener("DOMContentLoaded",()=>{
      renderUserIcon();
      if(typeof ensureLocalAuthFromActiveOwner==="function"){ensureLocalAuthFromActiveOwner();}
      setTimeout(()=>{if(typeof renderFollowBoxesSafe==="function")renderFollowBoxesSafe();},0);
      window.addEventListener("storage",e=>{
        if(!e.key)return;
        if(e.key==="users"||e.key==="authUserId"||e.key==="profile"||(e.key||"").startsWith("profile:")){
          if(typeof renderFollowBoxesSafe==="function")renderFollowBoxesSafe();
        }
      });
    });
  </script>

  <footer>&copy; 2025 zange (テスト公開中)</footer>
</body>
</html>
