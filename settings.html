<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />
  <script>
    /* æ—¢å­˜ï¼šåŒä¸€ã‚ªãƒªã‚¸ãƒ³ API ã‚’æœ€å„ªå…ˆ */
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + '/api/posts';
  </script>
  <style>
    .section-title{font-weight:800;font-size:18px;margin:8px 0 6px;}
    .card.form{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--panel-border,#eee);background:#f6f6f6;display:block}
    .avatar-wrap{display:flex;flex-direction:column;gap:6px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .muted{color:#8a8a8a}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9}
    #profileView p{margin:2px 0}
    #profileView .name{font-weight:700;font-size:16px}
    #profileView .meta{font-size:13px;color:#6b7280}
    #profileView .bio{margin-top:4px}

    /* ãƒ•ã‚©ãƒ­ãƒ¼ä¸€è¦§ã‚’ã‚¿ãƒ–ã®ä¸‹ã«å‡ºã™ï¼ˆã‚ãªãŸã®ç’°å¢ƒã§æ—¢ã«åŠ¹ã„ã¦ã„ã‚‹ä½“è£ã¯ç¶­æŒï¼‰ */
    .follow-tabs{ display:block !important; }
    .follow-tabs .tabbar{ display:flex !important; gap:12px; align-items:center; margin-bottom:8px; position:relative; }
    .follow-tabs .tabpanel{ display:block !important; clear:both !important; margin-top:6px; }
    .follow-tabs .follow-stats.under{ display:block !important; margin:6px 0 10px; clear:both !important; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main style="padding-bottom:90px">
    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div class="card form">
      <div id="profileView">
        <div class="row">
          <div class="avatar-wrap">
            <!-- ç›¸å¯¾ãƒ‘ã‚¹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã—ã¦ 404 ã‚’ç¢ºå®Ÿã«å›é¿ -->
            <img id="profileAvatarShow" class="avatar" alt="avatar"
                 src="images/default-avatar.png"
                 onerror="this.src='images/default-avatar.png'">
          </div>
          <div class="field" style="min-width:180px;flex:2">
            <p id="profileNameShow" class="name">åŒ¿å</p>
            <p id="profileGenderShow" class="meta">æ€§åˆ¥: â€”</p>
            <p id="profileAgeShow" class="meta">å¹´é½¢: â€”</p>
            <p id="profileBioShow" class="bio">è‡ªå·±ç´¹ä»‹: â€”</p>
          </div>
          <div class="right"><button id="editProfileBtn" class="btn">ç·¨é›†</button></div>
        </div>
      </div>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜UIã€‚JSã¯ script.js ã«å§”è­²ï¼‰ -->
      <div id="profileEdit" style="display:none;">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarPreview" class="avatar" alt="avatar" src="images/default-avatar.png"
                 onerror="this.src='images/default-avatar.png'">
            <label class="btn">
              ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒè¨­å®š
              <input id="profileAvatarInput" type="file" accept="image/*" style="display:none">
            </label>
          </div>
          <div class="field">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
            <input id="profileNickname" type="text" placeholder="ä¾‹ï¼‰zangeå¤ªéƒ">
          </div>
          <div class="field" style="max-width:140px">
            <label>æ€§åˆ¥</label>
            <select id="profileGender">
              <option value="">æœªé¸æŠ</option><option>ç”·æ€§</option><option>å¥³æ€§</option><option>ãã®ä»–</option><option>å›ç­”ã—ãªã„</option>
            </select>
          </div>
          <div class="field" style="max-width:140px">
            <label>å¹´é½¢</label>
            <select id="profileAge">
              <option value="">æœªé¸æŠ</option>
              <option>ã€œ19</option><option>20-24</option><option>25-29</option>
              <option>30-34</option><option>35-39</option><option>40-44</option>
              <option>45-49</option><option>50-59</option><option>60+</option>
            </select>
          </div>
          <div class="field" style="flex-basis:100%">
            <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
            <textarea id="profileBio" rows="3" placeholder="ã²ã¨ã“ã¨è‡ªå·±ç´¹ä»‹"></textarea>
          </div>
        </div>
        <div class="btn-row">
          <button id="profileSaveBtn" class="btn primary">ä¿å­˜</button>
          <button id="profileCancelBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ -->
    <section class="card">
      <div class="follow-tabs">
        <div class="tabbar" role="tablist" aria-label="follow tabs">
          <button id="tab-followers" class="tab2" role="tab"
                  aria-selected="false" aria-controls="pane-followers">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</button>
          <button id="tab-following" class="tab2 active" role="tab"
                  aria-selected="true" aria-controls="pane-following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
          <span class="tab-underline" aria-hidden="true"></span>
        </div>

        <div id="followStats" class="follow-stats under"></div>

        <div id="pane-following" class="tabpanel show" role="tabpanel" aria-labelledby="tab-following">
          <div id="followingList"></div>
        </div>

        <div id="pane-followers" class="tabpanel" role="tabpanel" aria-labelledby="tab-followers" hidden>
          <div id="followersList"></div>
        </div>
      </div>
    </section>

    <!-- è‡ªåˆ†ã®æŠ•ç¨¿ï¼ˆæ—¢å­˜ãã®ã¾ã¾ï¼‰ -->
    <div class="card form" style="margin-top:16px">
      <div class="section-title">è‡ªåˆ†ã®æŠ•ç¨¿</div>
      <div class="my-posts-toolbar">
        <input id="myPostsSearch" type="search" inputmode="search" placeholder="è‡ªåˆ†ã®æŠ•ç¨¿ã‚’æ¤œç´¢ï¼ˆæœ¬æ–‡ãƒ»å¯¾è±¡ãƒ»ã‚¿ã‚°ï¼‰">
      </div>
      <div id="myPostsList"></div>
    </div>
  </main>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">ğŸ </span><span class="label">ãƒ›ãƒ¼ãƒ </span></a>
      <a href="topics.html"><span class="icon">ğŸ¯</span><span class="label">ãŠé¡Œ</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">ğŸ””</span><span id="notifBadge" class="notif-badge" aria-label="æœªèª­é€šçŸ¥æ•°"></span></span>
        <span class="label">é€šçŸ¥</span>
      </a>
      <a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">è¨­å®š</span></a>
      <a href="about.html"><span class="icon">ğŸ“•</span><span class="label">æ¦‚è¦</span></a>
    </nav>
  </footer>
  <a class="fab" href="post.html"><span class="emoji">ğŸ™</span></a>

  <!-- æ—¢å­˜ã‚¢ãƒ—ãƒªã®ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script src="script.js"></script>

  <!-- â˜… è¿½åŠ ï¼šé¡”ç”»åƒä»˜ãã§ãƒ•ã‚©ãƒ­ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‚’â€œä¸Šæ›¸ãæç”»â€ã™ã‚‹è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ â˜… -->
  <script>
    const _esc = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const AVA_FALLBACK = 'images/default-avatar.png'; // ç›¸å¯¾ãƒ‘ã‚¹ã§ 404 ã«ãªã‚‰ãªã„

    function resolveProfileById(uid){
      try{
        // 1) profile:<uid>ï¼ˆsettings ã§ä¿å­˜ã—ãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰
        const p = JSON.parse(localStorage.getItem('profile:'+uid) || '{}');
        if (p && (p.nickname || p.avatar)) return p;
      }catch(_){}

      try{
        // 2) users[uid].profileï¼ˆã‚¢ãƒ—ãƒªå†…éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¾æ›¸ï¼‰
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const u = users && users[uid];
        if (u && u.profile) return u.profile;
      }catch(_){}

      return {};
    }

    function avatarOf(uid){
      const p = resolveProfileById(uid);
      return (p && p.avatar) ? p.avatar : AVA_FALLBACK;
    }
    function nameOf(uid){
      const p = resolveProfileById(uid);
      return p.nickname || p.email || uid;
    }

    // æ—¢å­˜ã®ãƒªã‚¹ãƒˆæç”»å¾Œã«â€œè¦‹ãŸç›®ã ã‘â€ã‚’ç½®ãæ›ãˆã‚‹
    function enhanceFollowListsWithAvatars(){
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const meId  = localStorage.getItem('authUserId');
      const me    = users[meId] || {};
      const following = me.following || [];
      const followers = me.followers || [];

      // æ—¢å­˜ã®ã€Œå¤–ã™ã€å‹•ä½œã¯ unfollowUser ã«ãã®ã¾ã¾å§”è­²
      const rowHTML = (uid, withUnfollow) => `
        <div class="follow-row" data-uid="${_esc(uid)}" style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f1f5f9;">
          <a class="follow-link" href="user.html?id=${encodeURIComponent(uid)}" style="display:flex;align-items:center;gap:8px;text-decoration:none;color:inherit">
            <img src="${_esc(avatarOf(uid))}" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover" onerror="this.src='${AVA_FALLBACK}'">
            <span class="name" style="font-weight:600">${_esc(nameOf(uid))}</span>
          </a>
          ${withUnfollow ? `<button type="button" class="btn" data-uid="${_esc(uid)}" style="margin-left:auto">å¤–ã™</button>` : ``}
        </div>`.trim();

      const fList = document.getElementById('followingList');
      if (fList) {
        fList.innerHTML = following.length ? following.map(uid => rowHTML(uid, true)).join('') : 'ãªã—';
      }
      const rList = document.getElementById('followersList');
      if (rList) {
        rList.innerHTML = followers.length ? followers.map(uid => rowHTML(uid, false)).join('') : 'ãªã—';
      }

      // ã€Œå¤–ã™ã€ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆæ—¢å­˜ã® unfollowUser ãŒã‚ã‚Œã°ä½¿ã†ï¼‰
      document.querySelectorAll('#followingList .btn[data-uid]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const uid = btn.getAttribute('data-uid');
          if (typeof unfollowUser === 'function') {
            unfollowUser(uid);
          } else {
            // å¿µã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ï¼‰
            try{
              const users = JSON.parse(localStorage.getItem('users') || '{}');
              const me = users[localStorage.getItem('authUserId')] || (users[localStorage.getItem('authUserId')] = {following:[],followers:[]});
              me.following = (me.following||[]).filter(x => x !== uid);
              localStorage.setItem('users', JSON.stringify(users));
            }catch(_){}
          }
          enhanceFollowListsWithAvatars(); // å³æ™‚å†æç”»
        });
      });
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã®å³æ™‚ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆè¡¨ç¤ºãŒæ¶ˆãˆãªã„ã‚ˆã†ã€å…ˆã«åŸ‹ã‚ã‚‹ï¼‰
    function bootstrapProfileView(){
      try{
        if(typeof getProfile!=="function") return;
        const p=getProfile()||{};
        const a=document.getElementById("profileAvatarShow");
        const n=document.getElementById("profileNameShow");
        const g=document.getElementById("profileGenderShow");
        const ag=document.getElementById("profileAgeShow");
        const b=document.getElementById("profileBioShow");
        if(a && p.avatar) a.src=p.avatar;
        if(n) n.textContent = p.nickname || "åŒ¿å";
        if(g) g.textContent = "æ€§åˆ¥: " + (p.gender || "â€”");
        if(ag) ag.textContent = "å¹´é½¢: " + (p.age || "â€”");
        if(b) b.textContent = "è‡ªå·±ç´¹ä»‹: " + (p.bio || "â€”");
      }catch(_){}
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæ—¢å­˜ï¼‰
    async function renderUserIcon(){
      const box = document.getElementById("currentUserIcon");
      if (!box) return;
      try{
        const res = await fetch("/api/me",{ credentials:"include", cache:"no-store" });
        const data = await res.json();
        if (data.ok && data.user){
          const name = data.user.nickname || data.user.email;
          box.innerHTML = `<span class="pill">ğŸ‘¤ ${_esc(name)}</span>`;
        }else{
          box.innerHTML = `<a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>`;
        }
      }catch{
        box.innerHTML = `<a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>`;
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      renderUserIcon();
      bootstrapProfileView();

      // æ—¢å­˜ã®åˆæœŸåŒ–ï¼ˆã‚ã‚Œã°èµ°ã‚‰ã›ã‚‹ï¼‰
      if (typeof ensureLocalAuthFromActiveOwner === 'function') ensureLocalAuthFromActiveOwner();
      if (typeof initProfileUI === 'function') initProfileUI();
      if (typeof renderFollowBoxesSafe === 'function') renderFollowBoxesSafe();

      // é¡”ç”»åƒä»˜ãã«ä¸Šæ›¸ã
      enhanceFollowListsWithAvatars();

      // ä»–ã‚¿ãƒ–/ä»–ãƒšãƒ¼ã‚¸ã§ãƒ•ã‚©ãƒ­ãƒ¼ã‚„ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå¤‰ã‚ã£ãŸã‚‰å³è¿½éš
      window.addEventListener('storage', (e)=>{
        if (!e.key) return;
        if (e.key === 'users' || e.key === 'authUserId' || e.key === 'profile' || e.key.startsWith('profile:')){
          bootstrapProfileView();
          if (typeof renderFollowBoxesSafe === 'function') renderFollowBoxesSafe();
          enhanceFollowListsWithAvatars();
        }
      });
    });
  </script>

  <footer>&copy; 2025 zange (ãƒ†ã‚¹ãƒˆå…¬é–‹ä¸­)</footer>
</body>
</html>
