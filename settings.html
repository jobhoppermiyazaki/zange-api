<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />

  <script>
    /* Render ã®åŒä¸€ã‚ªãƒªã‚¸ãƒ³ API ã‚’æœ€å„ªå…ˆã«ä½¿ã†ï¼ˆæ—¢å­˜ï¼‰ */
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + '/api/posts';
  </script>

  <style>
    .section-title{font-weight:800;font-size:18px;margin:8px 0 6px;}
    .card.form{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--panel-border,#eee);background:#f6f6f6;display:block}
    .avatar-wrap{display:flex;flex-direction:column;gap:6px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .field input[type="text"], .field input[type="number"], .field textarea, .field select{width:100%}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;box-shadow:var(--shadow);cursor:pointer}
    .btn.danger{background:#ffecec;border-color:#ffc9c9}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    .muted{color:#8a8a8a}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9}
    .my-post .edit-area{margin-top:8px;display:none !important;}
    .my-post.editing .edit-area{display:block !important;}
    #profileView p{margin:2px 0}
    #profileView .name{font-weight:700;font-size:16px}
    #profileView .meta{font-size:13px;color:#6b7280}
    #profileView .bio{margin-top:4px}

    /* --- ãƒ•ã‚©ãƒ­ãƒ¼ä¸€è¦§ã‚’ã‚¿ãƒ–ã®ã€Œä¸‹ã€ã«ç¸¦ç©ã¿è¡¨ç¤º --- */
    .follow-tabs{ display:block !important; align-items:unset !important; justify-content:unset !important; }
    .follow-tabs .tabbar{ display:flex !important; gap:12px; align-items:center; margin-bottom:8px; position:relative; }
    .follow-tabs .tab-underline{ position:absolute; bottom:-2px; left:0; height:2px; width:50%; }
    .follow-tabs .tabpanel{ display:block !important; width:100% !important; clear:both !important; margin-top:6px; }
    .follow-tabs .follow-stats.under{ display:block !important; margin:6px 0 10px; clear:both !important; }
    #followingList, #followersList{ display:block !important; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main style="padding-bottom:90px">
    <!-- è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‹ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div class="card form">
      <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
      <div id="profileView">
        <div class="row">
          <div class="avatar-wrap">
            <!-- åˆæœŸã¯ãƒ‡ãƒ¼ã‚¿URIï¼ˆ404å¯¾ç­–ï¼‰ã€‚å¾Œã§ initProfileUI / bootstrap ã§å·®ã—æ›¿ãˆ -->
            <img id="profileAvatarShow"
                 class="avatar"
                 alt="avatar"
                 src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="84" height="84" viewBox="0 0 84 84"><circle cx="42" cy="42" r="42" fill="%23f1f5f9"/><circle cx="42" cy="34" r="14" fill="%23cbd5e1"/><rect x="16" y="52" width="52" height="20" rx="10" fill="%23cbd5e1"/></svg>'>
          </div>
          <div class="field" style="min-width:180px;flex:2">
            <p id="profileNameShow" class="name">åŒ¿å</p>
            <p id="profileGenderShow" class="meta">æ€§åˆ¥: â€”</p>
            <p id="profileAgeShow" class="meta">å¹´é½¢: â€”</p>
            <p id="profileBioShow" class="bio">è‡ªå·±ç´¹ä»‹: â€”</p>
          </div>
          <div class="right">
            <button id="editProfileBtn" class="btn">ç·¨é›†</button>
          </div>
        </div>
      </div>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
      <div id="profileEdit" style="display:none;">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarPreview"
                 class="avatar"
                 alt="avatar"
                 src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="84" height="84" viewBox="0 0 84 84"><circle cx="42" cy="42" r="42" fill="%23f1f5f9"/><circle cx="42" cy="34" r="14" fill="%23cbd5e1"/><rect x="16" y="52" width="52" height="20" rx="10" fill="%23cbd5e1"/></svg>'>
            <label class="btn">
              ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒè¨­å®š
              <input id="profileAvatarInput" type="file" accept="image/*" style="display:none">
            </label>
          </div>
          <div class="field">
            <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
            <input id="profileNickname" type="text" placeholder="ä¾‹ï¼‰zangeå¤ªéƒ">
          </div>
          <div class="field" style="max-width:140px">
            <label>æ€§åˆ¥</label>
            <select id="profileGender">
              <option value="">æœªé¸æŠ</option>
              <option>ç”·æ€§</option>
              <option>å¥³æ€§</option>
              <option>ãã®ä»–</option>
              <option>å›ç­”ã—ãªã„</option>
            </select>
          </div>
          <div class="field" style="max-width:140px">
            <label>å¹´é½¢</label>
            <select id="profileAge">
              <option value="">æœªé¸æŠ</option>
              <option>ã€œ19</option><option>20-24</option><option>25-29</option>
              <option>30-34</option><option>35-39</option><option>40-44</option>
              <option>45-49</option><option>50-59</option><option>60+</option>
            </select>
          </div>
          <div class="field" style="flex-basis:100%">
            <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
            <textarea id="profileBio" rows="3" placeholder="ã²ã¨ã“ã¨è‡ªå·±ç´¹ä»‹"></textarea>
          </div>
        </div>
        <div class="btn-row">
          <button id="profileSaveBtn" class="btn primary">ä¿å­˜</button>
          <button id="profileCancelBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ -->
    <section class="card">
      <div class="follow-tabs">
        <div class="tabbar" role="tablist" aria-label="follow tabs">
          <button id="tab-followers" class="tab2" role="tab"
                  aria-selected="false" aria-controls="pane-followers">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</button>
          <button id="tab-following" class="tab2 active" role="tab"
                  aria-selected="true" aria-controls="pane-following">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</button>
          <span class="tab-underline" aria-hidden="true"></span>
        </div>

        <div id="followStats" class="follow-stats under"></div>

        <div id="pane-following" class="tabpanel show" role="tabpanel" aria-labelledby="tab-following">
          <div id="followingList"></div>
        </div>

        <div id="pane-followers" class="tabpanel" role="tabpanel" aria-labelledby="tab-followers" hidden>
          <div id="followersList"></div>
        </div>
      </div>
    </section>

    <!-- è‡ªåˆ†ã®æŠ•ç¨¿ -->
    <div class="card form" style="margin-top:16px">
      <div class="section-title">è‡ªåˆ†ã®æŠ•ç¨¿</div>
      <div class="my-posts-toolbar">
        <input id="myPostsSearch" type="search" inputmode="search" placeholder="è‡ªåˆ†ã®æŠ•ç¨¿ã‚’æ¤œç´¢ï¼ˆæœ¬æ–‡ãƒ»å¯¾è±¡ãƒ»ã‚¿ã‚°ï¼‰">
      </div>
      <div id="myPostsList"></div>
    </div>
  </main>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">ğŸ </span><span class="label">ãƒ›ãƒ¼ãƒ </span></a>
      <a href="topics.html"><span class="icon">ğŸ¯</span><span class="label">ãŠé¡Œ</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">ğŸ””</span><span id="notifBadge" class="notif-badge" aria-label="æœªèª­é€šçŸ¥æ•°"></span></span>
        <span class="label">é€šçŸ¥</span>
      </a>
      <a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">è¨­å®š</span></a>
      <a href="about.html"><span class="icon">ğŸ“•</span><span class="label">æ¦‚è¦</span></a>
    </nav>
  </footer>
  <a class="fab" href="post.html"><span class="emoji">ğŸ™</span></a>

  <!-- æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆusers/following/Followers / initProfileUI ãªã©ï¼‰ -->
  <script src="script.js"></script>

  <!-- ãƒšãƒ¼ã‚¸å›ºæœ‰ï¼šãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤º + ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å³æ™‚ãƒ–ãƒ¼ã‚¹ãƒˆ + ãƒ•ã‚©ãƒ­ãƒ¼æ¬„ã¸ã®é¡”å†™çœŸè¿½åŠ  -->
  <script>
    function esc(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    const AVA_FALLBACK_URL = "images/default-avatar.png";
    const AVA_FALLBACK_DATAURI =
      'data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 84 84"><circle cx="42" cy="42" r="42" fill="%23f1f5f9"/><circle cx="42" cy="34" r="14" fill="%23cbd5e1"/><rect x="16" y="52" width="52" height="20" rx="10" fill="%23cbd5e1"/></svg>';

    // 1) ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤ºï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ç›´ã—æ¸ˆã¿ï¼‰
    async function renderUserIcon(){
      const box=document.getElementById("currentUserIcon"); if(!box) return;
      try{
        const res=await fetch("/api/me",{credentials:"include",cache:"no-store"});
        const data=await res.json();
        if(data.ok&&data.user){
          const name=data.user.nickname||data.user.email;
          box.innerHTML=<span class="pill">ğŸ‘¤ ${esc(name)}</span>;
        }else{
          box.innerHTML=<a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>;
        }
      }catch{
        box.innerHTML=<a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>;
      }
    }

    // 2) è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ¬„ã‚’å³æç”»ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ç›´ã—æ¸ˆã¿ï¼‰
    function bootstrapProfileView(){
      try{
        if(typeof getProfile!=="function") return;
        const p=getProfile()||{};
        const a=document.getElementById("profileAvatarShow");
        const n=document.getElementById("profileNameShow");
        const g=document.getElementById("profileGenderShow");
        const ag=document.getElementById("profileAgeShow");
        const b=document.getElementById("profileBioShow");
        if(a && p.avatar){ a.src=p.avatar; }
        if(n){ n.textContent=p.nickname||"åŒ¿å"; }
        if(g){ g.textContent=æ€§åˆ¥: ${p.gender||"â€”"}; }
        if(ag){ ag.textContent=å¹´é½¢: ${p.age||"â€”"}; }
        if(b){ b.textContent=è‡ªå·±ç´¹ä»‹: ${p.bio||"â€”"}; }
      }catch(_){}
    }

    // ---- ã“ã“ã‹ã‚‰é¡”å†™çœŸã®å¾Œä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯ ----
    function findAvatarByNickname(nickname){
      if(!nickname) return null;

      // 1) getUsers() ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
      try{
        if(typeof getUsers==="function"){
          const us=getUsers()||[];
          const u=us.find(u=> (u.profile?.nickname||u.email) === nickname );
          if(u && u.profile?.avatar) return u.profile.avatar;
        }
      }catch(_){}

      // 2) localStorage users
      try{
        const users=JSON.parse(localStorage.getItem("users")||"{}");
        for(const uid in users){
          const prof=users[uid]?.profile;
          const name=(prof?.nickname)||users[uid]?.email;
          if(name===nickname && prof?.avatar) return prof.avatar;
        }
      }catch(_){}

      // 3) profile:<uid> ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¸€è‡´ï¼‰
      try{
        for(let i=0;i<localStorage.length;i++){
          const k=localStorage.key(i)||"";
          if(!k.startsWith("profile:")) continue;
          const p=JSON.parse(localStorage.getItem(k)||"{}");
          const name=p?.nickname||p?.email;
          if(name===nickname && p?.avatar) return p.avatar;
        }
      }catch(_){}

      return null;
    }

    // è¡Œè¦ç´ ã‹ã‚‰ã€Œåå‰ã‚‰ã—ãã€æ–‡å­—åˆ—ã‚’æŠ½å‡ºï¼ˆãƒœã‚¿ãƒ³ã‚„ç”»åƒã¯é™¤å¤–ï¼‰
    function extractNicknameFromRow(row){
      // attribute å„ªå…ˆ
      const byAttr = row.getAttribute?.("data-nickname");
      if(byAttr) return byAttr.trim();

      // ã‚ˆãã‚ã‚‹ã‚¯ãƒ©ã‚¹å
      const byClass = row.querySelector?.(".name,.nickname,.follow-name");
      if(byClass && byClass.textContent) return byClass.textContent.trim();

      // ã ã‚ãªã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€Œå¤–ã™ã€ã€Œå‰Šé™¤ã€ãªã©ã®ãƒœã‚¿ãƒ³æ–‡å­—ã‚’å–ã‚Šé™¤ã
      const clone = row.cloneNode(true);
      clone.querySelectorAll("button,img,svg").forEach(el=>el.remove());
      const t = (clone.textContent||"").replace(/å¤–ã™|å‰Šé™¤|ãƒ•ã‚©ãƒ­ãƒ¼ä¸­|ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼|ãªã—/g,"").trim();
      return t || null;
    }

    // ãƒªã‚¹ãƒˆã® <img> ã‚’è£œæ­£ãƒ»å·®ã—æ›¿ãˆ
    function enhanceFollowLists(){
      ["followingList","followersList"].forEach(listId=>{
        const box=document.getElementById(listId); if(!box) return;

        // è¡Œï¼ç›´ä¸‹ã®å­è¦ç´ ã‚’ã–ã£ãã‚Šå…¨éƒ¨è¦‹ã‚‹ï¼ˆæ—¢å­˜DOMã‚’å£Šã•ãªã„ï¼‰
        Array.from(box.children).forEach(row=>{
          if(!(row && row.nodeType===1)) return;

          // ç”»åƒè¦ç´ ã‚’ç¢ºä¿ï¼ˆç„¡ã‘ã‚Œã°å…ˆé ­ã«ä½œã‚‹ï¼‰
          let img = row.querySelector("img");
          if(!img){
            img = document.createElement("img");
            img.alt="";
            img.style.cssText="width:28px;height:28px;border-radius:50%;object-fit:cover;margin-right:6px;flex:0 0 auto;";
            row.insertBefore(img, row.firstChild);
          }

          // ã©ã‚“ãªå ´åˆã§ã‚‚ onerror ã§æœ€çµ‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å€’ã™
          img.onerror = ()=>{ img.onerror=null; img.src = AVA_FALLBACK_URL; img.onerror=()=>{ img.src=AVA_FALLBACK_DATAURI; }; };

          // æ—¢å­˜ãŒ API ãƒ‰ãƒ¡ã‚¤ãƒ³ /images/default-avatar.png ãªã©ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã«ç½®ãæ›ãˆ
          if(!img.src || /\/images\/default-avatar\.png/i.test(img.src) || /onrender\.com\/images\/default-avatar\.png/i.test(img.src)){
            img.src = AVA_FALLBACK_URL;
          }

          // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‹ã‚‰ã‚¢ãƒã‚¿ãƒ¼ã‚’è§£æ±º
          const nickname = extractNicknameFromRow(row);
          const found = findAvatarByNickname(nickname);
          if(found){
            if(img.src !== found) img.src = found;
          }else{
            // è¦‹ã¤ã‹ã‚‰ãªãã¦ã‚‚æœ€ä½é™ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ã†ï¼ˆ404ã—ãªã„ï¼‰
            img.src = AVA_FALLBACK_URL;
          }
        });
      });
    }

    // ---- åˆæœŸåŒ–é †åºã‚’æƒãˆã‚‹ ----
    document.addEventListener("DOMContentLoaded", ()=>{
      renderUserIcon();
      bootstrapProfileView();

      // ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ­ãƒ¼ã‚«ãƒ«åŒæœŸï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
      if(typeof ensureLocalAuthFromActiveOwner==="function") ensureLocalAuthFromActiveOwner();

      // æ—¢å­˜ã®åˆæœŸåŒ–
      if(typeof initProfileUI==="function") initProfileUI();
      if(typeof renderFollowBoxesSafe==="function") renderFollowBoxesSafe();

      // é¡”å†™çœŸã®å¾Œä»˜ã‘ï¼ˆæç”»å¾Œã«ç¢ºå®Ÿã«èµ°ã‚‰ã›ã‚‹ï¼‰
      setTimeout(enhanceFollowLists, 80);

      // ã‚¿ãƒ–åˆ‡æ›¿ã‚„ãƒ•ã‚©ãƒ­ãƒ¼æ“ä½œã§ãƒªã‚¹ãƒˆãŒå·®ã—æ›¿ã‚ã‚‹æƒ³å®š â†’ ç›£è¦–ã—ã¦å†é©ç”¨
      ["followingList","followersList"].forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        const mo=new MutationObserver(()=>enhanceFollowLists());
        mo.observe(el,{childList:true,subtree:false});
      });

      // ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®å¤‰æ›´ã«ã‚‚è¿½éš
      window.addEventListener("storage",(e)=>{
        if(!e.key) return;
        if(e.key==="users"||e.key==="authUserId"||e.key==="profile"||(e.key||"").startsWith("profile:")){
          if(typeof renderFollowBoxesSafe==="function") renderFollowBoxesSafe();
          setTimeout(enhanceFollowLists, 50);
        }
      });
    });
  </script>

  <footer>&copy; 2025 zange (ãƒ†ã‚¹ãƒˆå…¬é–‹ä¸­)</footer>
</body>
</html>
