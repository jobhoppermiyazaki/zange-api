<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - マイページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />

  <script>
    /* Render の同一オリジン API を最優先に使う（既存） */
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + '/api/posts';
  </script>

  <style>
    .section-title{font-weight:800;font-size:18px;margin:8px 0 6px;}
    .card.form{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--panel-border,#eee);background:#f6f6f6;display:block}
    .avatar-wrap{display:flex;flex-direction:column;gap:6px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .field input[type="text"], .field input[type="number"], .field textarea, .field select{width:100%}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;box-shadow:var(--shadow);cursor:pointer}
    .btn.danger{background:#ffecec;border-color:#ffc9c9}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    .muted{color:#8a8a8a}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9}
    .my-post .edit-area{margin-top:8px;display:none !important;}
    .my-post.editing .edit-area{display:block !important;}
    #profileView p{margin:2px 0}
    #profileView .name{font-weight:700;font-size:16px}
    #profileView .meta{font-size:13px;color:#6b7280}
    #profileView .bio{margin-top:4px}

    /* --- フォロー一覧をタブの「下」に縦積み表示 --- */
    .follow-tabs{ display:block !important; align-items:unset !important; justify-content:unset !important; }
    .follow-tabs .tabbar{ display:flex !important; gap:12px; align-items:center; margin-bottom:8px; position:relative; }
    .follow-tabs .tab-underline{ position:absolute; bottom:-2px; left:0; height:2px; width:50%; }
    .follow-tabs .tabpanel{ display:block !important; width:100% !important; clear:both !important; margin-top:6px; }
    .follow-tabs .follow-stats.under{ display:block !important; margin:6px 0 10px; clear:both !important; }
    #followingList, #followersList{ display:block !important; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main style="padding-bottom:90px">
    <!-- 自分のプロフィール（表示モード＋編集モード） -->
    <div class="card form">
      <!-- 表示モード -->
      <div id="profileView">
        <div class="row">
          <div class="avatar-wrap">
            <!-- 初期はデータURI（404対策）。ロード後にサーバー値へ差し替え -->
            <img id="profileAvatarShow"
                 class="avatar"
                 alt="avatar"
                 src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="84" height="84" viewBox="0 0 84 84"><circle cx="42" cy="42" r="42" fill="%23f1f5f9"/><circle cx="42" cy="34" r="14" fill="%23cbd5e1"/><rect x="16" y="52" width="52" height="20" rx="10" fill="%23cbd5e1"/></svg>'>
          </div>
          <div class="field" style="min-width:180px;flex:2">
            <p id="profileNameShow" class="name">匿名</p>
            <p id="profileGenderShow" class="meta">性別: —</p>
            <p id="profileAgeShow" class="meta">年齢: —</p>
            <p id="profileBioShow" class="bio">自己紹介: —</p>
          </div>
          <div class="right">
            <button id="editProfileBtn" class="btn">編集</button>
          </div>
        </div>
      </div>

      <!-- 編集モード（初期は非表示） -->
      <div id="profileEdit" style="display:none;">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarPreview"
                 class="avatar"
                 alt="avatar"
                 src='data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="84" height="84" viewBox="0 0 84 84"><circle cx="42" cy="42" r="42" fill="%23f1f5f9"/><circle cx="42" cy="34" r="14" fill="%23cbd5e1"/><rect x="16" y="52" width="52" height="20" rx="10" fill="%23cbd5e1"/></svg>'>
            <label class="btn">
              プロフィール画像設定
              <input id="profileAvatarInput" type="file" accept="image/*" style="display:none">
            </label>
          </div>
          <div class="field">
            <label>ニックネーム</label>
            <input id="profileNickname" type="text" placeholder="例）zange太郎">
          </div>
          <div class="field" style="max-width:140px">
            <label>性別</label>
            <select id="profileGender">
              <option value="">未選択</option>
              <option>男性</option>
              <option>女性</option>
              <option>その他</option>
              <option>回答しない</option>
            </select>
          </div>
          <div class="field" style="max-width:140px">
            <label>年齢</label>
            <select id="profileAge">
              <option value="">未選択</option>
              <option>〜19</option><option>20-24</option><option>25-29</option>
              <option>30-34</option><option>35-39</option><option>40-44</option>
              <option>45-49</option><option>50-59</option><option>60+</option>
            </select>
          </div>
          <div class="field" style="flex-basis:100%">
            <label>プロフィール</label>
            <textarea id="profileBio" rows="3" placeholder="ひとこと自己紹介"></textarea>
          </div>
        </div>
        <div class="btn-row">
          <button id="profileSaveBtn" class="btn primary">保存</button>
          <button id="profileCancelBtn" class="btn">キャンセル</button>
        </div>
      </div>
    </div>

    <!-- フォロー・フォロワー -->
    <section class="card">
      <div class="follow-tabs">
        <div class="tabbar" role="tablist" aria-label="follow tabs">
          <button id="tab-followers" class="tab2" role="tab"
                  aria-selected="false" aria-controls="pane-followers">フォロワー</button>
          <button id="tab-following" class="tab2 active" role="tab"
                  aria-selected="true" aria-controls="pane-following">フォロー中</button>
          <span class="tab-underline" aria-hidden="true"></span>
        </div>

        <div id="followStats" class="follow-stats under"></div>

        <div id="pane-following" class="tabpanel show" role="tabpanel" aria-labelledby="tab-following">
          <div id="followingList"></div>
        </div>

        <div id="pane-followers" class="tabpanel" role="tabpanel" aria-labelledby="tab-followers" hidden>
          <div id="followersList"></div>
        </div>
      </div>
    </section>

    <!-- 自分の投稿 -->
    <div class="card form" style="margin-top:16px">
      <div class="section-title">自分の投稿</div>
      <div class="my-posts-toolbar">
        <input id="myPostsSearch" type="search" inputmode="search" placeholder="自分の投稿を検索（本文・対象・タグ）">
      </div>
      <div id="myPostsList"></div>
    </div>
  </main>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">🏠</span><span class="label">ホーム</span></a>
      <a href="topics.html"><span class="icon">🎯</span><span class="label">お題</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">🔔</span><span id="notifBadge" class="notif-badge" aria-label="未読通知数"></span></span>
        <span class="label">通知</span>
      </a>
      <a href="settings.html"><span class="icon">⚙️</span><span class="label">設定</span></a>
      <a href="about.html"><span class="icon">📕</span><span class="label">概要</span></a>
    </nav>
  </footer>
  <a class="fab" href="post.html"><span class="emoji">🙏</span></a>

  <!-- 既存ロジック -->
  <script src="script.js"></script>

  <!-- ページ固有：サーバー真実値で同期（localStorage 不使用）＋ renderMyPosts をサーバー優先にパッチ -->
  <script>
    const AVA_FALLBACK_URL = "images/default-avatar.png";
    const AVA_FALLBACK_DATAURI =
      'data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 84 84"><circle cx="42" cy="42" r="42" fill="%23f1f5f9"/><circle cx="42" cy="34" r="14" fill="%23cbd5e1"/><rect x="16" y="52" width="52" height="20" rx="10" fill="%23cbd5e1"/></svg>';

    function esc(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    /* ===== 共通：現在ユーザー ===== */
    async function fetchActiveUser(){
      try{
        const res = await fetch("/api/me",{credentials:"include",cache:"no-store"});
        const data = await res.json();
        return (data && data.ok && data.user) ? data.user : null;
      }catch(e){ console.warn("fetchActiveUser failed:", e); return null; }
    }

    /* ===== ヘッダーのログイン表示 ===== */
    async function renderUserIcon(){
      const box=document.getElementById("currentUserIcon"); if(!box) return;
      const user = await fetchActiveUser();
      if(user){ box.innerHTML=`<span class="pill">👤 ${esc(user.nickname||user.email||"")}</span>`; }
      else{ box.innerHTML=`<a href="login.html">ログイン</a>`; }
    }

    /* ===== プロフィール描画（サーバー値のみ） ===== */
    async function renderProfileFromServer(){
      const user = await fetchActiveUser();
      const a=document.getElementById("profileAvatarShow");
      const n=document.getElementById("profileNameShow");
      const g=document.getElementById("profileGenderShow");
      const ag=document.getElementById("profileAgeShow");
      const b=document.getElementById("profileBioShow");

      if(!user){
        if(n) n.textContent="匿名";
        if(g) g.textContent="性別: —";
        if(ag) ag.textContent="年齢: —";
        if(b) b.textContent="自己紹介: —";
        return;
      }
      if(a){ a.onerror=()=>{ a.onerror=null; a.src=AVA_FALLBACK_URL; a.onerror=()=>{a.src=AVA_FALLBACK_DATAURI}; }; a.src=user.avatar||AVA_FALLBACK_URL; }
      if(n) n.textContent = user.nickname || user.name || user.email || "匿名";
      if(g) g.textContent = "性別: " + (user.gender || "—");
      if(ag) ag.textContent = "年齢: " + (user.age || "—");
      if(b) b.textContent = "自己紹介: " + (user.bio || "—");

      // 編集フォーム初期値（空欄のみ埋める）
      const nickI=document.getElementById("profileNickname");
      const genI=document.getElementById("profileGender");
      const ageI=document.getElementById("profileAge");
      const bioI=document.getElementById("profileBio");
      const prev=document.getElementById("profileAvatarPreview");
      if(nickI && !nickI.value) nickI.value = user.nickname || "";
      if(genI) genI.value = user.gender || "";
      if(ageI) ageI.value = user.age || "";
      if(bioI && !bioI.value) bioI.value = user.bio || "";
      if(prev && user.avatar) prev.src = user.avatar;
    }

    /* ===== 自分の投稿（サーバー値のみ） ===== */
    function fallbackRenderMyPosts(posts){
      const box = document.getElementById("myPostsList");
      if(!box) return;
      box.innerHTML = (posts||[]).map(p=>`
        <article class="card my-post" data-id="${esc(String(p.id||""))}">
          <div><strong>${esc(p.text||"")}</strong></div>
          <div class="muted" style="margin-top:4px">${esc(p.target||"—")} ／ ${esc((p.tags||[]).join(",")||"—")}</div>
        </article>
      `).join("");
    }

    // script.js の renderMyPosts を「サーバー優先」でラップ（既存仕様は維持）
    (function patchRenderMyPosts(){
      const orig = window.renderMyPosts;
      window.renderMyPosts = async function(arg){
        try{
          // 引数で配列が来たらそのまま既存へ（既存 UI を尊重）
          if(Array.isArray(arg)){
            if(typeof orig === "function"){ return orig(arg); }
            return fallbackRenderMyPosts(arg);
          }
          // 引数なし等：必ずサーバーから取得して渡す（localStorage を無視）
          const res = await fetch("/api/posts?mine=1",{credentials:"include",cache:"no-store"});
          const data = await res.json();
          const posts = (data && (data.posts||data)) || [];
          if(typeof orig === "function"){ return orig(posts); }
          return fallbackRenderMyPosts(posts);
        }catch(e){
          console.warn("renderMyPosts (patched) failed:", e);
        }
      };
    })();

    async function renderMyPostsFromServer(){
      try{
        const res = await fetch("/api/posts?mine=1",{credentials:"include",cache:"no-store"});
        const data = await res.json();
        const posts = (data && (data.posts||data)) || [];
        // 上書き済み renderMyPosts を経由して描画（既存UI維持）
        if(typeof window.renderMyPosts === "function") return window.renderMyPosts(posts);
        return fallbackRenderMyPosts(posts);
      }catch(e){ console.warn("renderMyPostsFromServer failed:", e); }
    }

    /* ===== フォロー欄の顔写真（サーバー問い合わせベース／API不在なら既存のまま） ===== */
    function extractNicknameFromRow(row){
      const byAttr = row.getAttribute?.("data-nickname");
      if(byAttr) return byAttr.trim();
      const byClass = row.querySelector?.(".name,.nickname,.follow-name");
      if(byClass && byClass.textContent) return byClass.textContent.trim();
      const clone = row.cloneNode(true);
      clone.querySelectorAll("button,img,svg").forEach(el=>el.remove());
      const t = (clone.textContent||"").replace(/外す|削除|フォロー中|フォロワー|なし/g,"").trim();
      return t || null;
    }

    async function fetchAvatarsByNicknames(nicks){
      if(!nicks.length) return {};
      const q = encodeURIComponent(nicks.join(","));
      const endpoints = [
        `/api/users?nicknames=${q}`,
        `/api/profiles?nicknames=${q}`
      ];
      for(const url of endpoints){
        try{
          const res = await fetch(url,{credentials:"include",cache:"no-store"});
          if(!res.ok) continue;
          const data = await res.json();
          const list = data.users || data.profiles || data || [];
          const map = {};
          (list||[]).forEach(u=>{
            const k = (u.nickname || u.name || "").trim();
            if(k) map[k] = u.avatar || "";
          });
          if(Object.keys(map).length) return map;
        }catch(_){}
      }
      return {};
    }

    async function enhanceFollowLists(){
      const ids=["followingList","followersList"];
      for(const listId of ids){
        const box=document.getElementById(listId); if(!box) continue;

        const rows = Array.from(box.children).filter(el=>el && el.nodeType===1);
        // 先に安全なデフォルト
        rows.forEach(row=>{
          let img = row.querySelector("img");
          if(!img){
            img = document.createElement("img");
            img.alt="";
            img.style.cssText="width:28px;height:28px;border-radius:50%;object-fit:cover;margin-right:6px;flex:0 0 auto;";
            row.insertBefore(img, row.firstChild);
          }
          img.onerror = ()=>{ img.onerror=null; img.src = AVA_FALLBACK_URL; img.onerror=()=>{ img.src=AVA_FALLBACK_DATAURI; }; };
          if(!img.src || /\/images\/default-avatar\.png/i.test(img.src)){
            img.src = AVA_FALLBACK_URL;
          }
        });

        // 一括問い合わせ（API があれば上書き）
        const names = rows.map(extractNicknameFromRow).filter(Boolean);
        const uniq = Array.from(new Set(names));
        const map = await fetchAvatarsByNicknames(uniq);
        rows.forEach(row=>{
          const name = extractNicknameFromRow(row);
          const url = name ? map[name] : "";
          if(url){
            const img = row.querySelector("img");
            if(img) img.src = url;
          }
        });
      }
    }

    /* ===== 初期化：常にサーバー真実値で描画 ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      await renderUserIcon();
      await renderProfileFromServer();
      await renderMyPostsFromServer();

      // 既存の初期化（UIロジック維持）
      if(typeof initProfileUI==="function") initProfileUI();
      if(typeof renderFollowBoxesSafe==="function") renderFollowBoxesSafe();

      // 顔写真の後付け（描画後）
      setTimeout(enhanceFollowLists, 80);

      // タブ切替や DOM 置換に対応して再適用
      ["followingList","followersList"].forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        const mo=new MutationObserver(()=>enhanceFollowLists());
        mo.observe(el,{childList:true,subtree:false});
      });

      // 端末間同期：画面復帰時に常に最新を再取得
      window.addEventListener("focus", async ()=>{
        await renderUserIcon();
        await renderProfileFromServer();
        await renderMyPostsFromServer();
        setTimeout(enhanceFollowLists, 50);
      });

      // プロフィール保存（サーバー API 前提・localStorage 不使用）
      const saveBtn=document.getElementById("profileSaveBtn");
      if(saveBtn){
        saveBtn.addEventListener("click", async ()=>{
          const body={
            nickname: (document.getElementById("profileNickname")||{}).value || "",
            gender  : (document.getElementById("profileGender")||{}).value || "",
            age     : (document.getElementById("profileAge")||{}).value || "",
            bio     : (document.getElementById("profileBio")||{}).value || "",
            avatar  : (document.getElementById("profileAvatarPreview")||{}).src || ""
          };
          try{
            const res=await fetch("/api/me",{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
            const data=await res.json();
            if(data && (data.ok===undefined || data.ok===true)){
              await renderProfileFromServer();
              setTimeout(enhanceFollowLists, 50);
            }else{
              alert("保存に失敗しました");
            }
          }catch(e){ console.error(e); alert("保存に失敗しました"); }
        });
      }
    });
  </script>

  <footer>&copy; 2025 zange (テスト公開中)</footer>
</body>
</html>
