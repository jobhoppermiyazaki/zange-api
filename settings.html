<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - マイページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />

  <script>
    window.ZANGE_API_BASE = location.origin.replace(/\/+$/, '') + '/api/posts';
  </script>

  <style>
    .section-title{font-weight:800;font-size:18px;margin:8px 0 6px;}
    .card.form{padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid var(--panel-border,#eee);background:#f6f6f6;display:block}
    .avatar-wrap{display:flex;flex-direction:column;gap:6px;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
    .btn.danger{background:#ffecec;border-color:#ffc9c9}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .right{margin-left:auto}
    .muted{color:#8a8a8a}
    .pill{padding:6px 10px;border-radius:999px;background:#f1f5f9}
    #profileView p{margin:2px 0}
    #profileView .name{font-weight:700;font-size:16px}
    #profileView .meta{font-size:13px;color:#6b7280}
    #profileView .bio{margin-top:4px}

    /* --- フォロー一覧をタブの「下」に縦積み表示 --- */
    .follow-tabs{ display:block !important; }
    .follow-tabs .tabbar{ display:flex; gap:12px; align-items:center; margin-bottom:8px; position:relative; }
    .follow-tabs .tab-underline{ position:absolute; bottom:-2px; left:0; height:2px; width:50%; }
    .follow-tabs .tabpanel{ display:block !important; clear:both !important; margin-top:6px; }
    .follow-tabs .follow-stats.under{ display:block !important; margin:6px 0 10px; clear:both !important; }
    #followingList, #followersList{ display:block !important; }

    /* フォロー一覧のアイテム */
    .follow-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f1f5f9;}
    .follow-item img{width:32px;height:32px;border-radius:50%;object-fit:cover;background:#eee;}
    .follow-item .name{font-weight:600;}
    .follow-item button{margin-left:auto;}
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main style="padding-bottom:90px">
    <!-- プロフィール -->
    <div class="card form">
      <div id="profileView">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarShow" class="avatar" alt="avatar"
                 src="images/default-avatar.png"
                 onerror="this.src='images/default-avatar.png'">
          </div>
          <div class="field" style="min-width:180px;flex:2">
            <p id="profileNameShow" class="name">匿名</p>
            <p id="profileGenderShow" class="meta">性別: —</p>
            <p id="profileAgeShow" class="meta">年齢: —</p>
            <p id="profileBioShow" class="bio">自己紹介: —</p>
          </div>
          <div class="right"><button id="editProfileBtn" class="btn">編集</button></div>
        </div>
      </div>
      <div id="profileEdit" style="display:none;">
        <div class="row">
          <div class="avatar-wrap">
            <img id="profileAvatarPreview" class="avatar" alt="avatar" src="images/default-avatar.png">
            <label class="btn">
              プロフィール画像設定
              <input id="profileAvatarInput" type="file" accept="image/*" style="display:none">
            </label>
          </div>
          <div class="field">
            <label>ニックネーム</label>
            <input id="profileNickname" type="text">
          </div>
          <div class="field" style="max-width:140px">
            <label>性別</label>
            <select id="profileGender">
              <option value="">未選択</option><option>男性</option><option>女性</option><option>その他</option><option>回答しない</option>
            </select>
          </div>
          <div class="field" style="max-width:140px">
            <label>年齢</label>
            <select id="profileAge">
              <option value="">未選択</option>
              <option>〜19</option><option>20-24</option><option>25-29</option>
              <option>30-34</option><option>35-39</option><option>40-44</option>
              <option>45-49</option><option>50-59</option><option>60+</option>
            </select>
          </div>
          <div class="field" style="flex-basis:100%">
            <label>プロフィール</label>
            <textarea id="profileBio" rows="3"></textarea>
          </div>
        </div>
        <div class="btn-row">
          <button id="profileSaveBtn" class="btn primary">保存</button>
          <button id="profileCancelBtn" class="btn">キャンセル</button>
        </div>
      </div>
    </div>

    <!-- フォロー -->
    <section class="card">
      <div class="follow-tabs">
        <div class="tabbar" role="tablist">
          <button id="tab-followers" class="tab2" role="tab">フォロワー</button>
          <button id="tab-following" class="tab2 active" role="tab">フォロー中</button>
          <span class="tab-underline"></span>
        </div>
        <div id="followStats" class="follow-stats under"></div>
        <div id="pane-following" class="tabpanel show"><div id="followingList"></div></div>
        <div id="pane-followers" class="tabpanel" hidden><div id="followersList"></div></div>
      </div>
    </section>

    <!-- 自分の投稿 -->
    <div class="card form" style="margin-top:16px">
      <div class="section-title">自分の投稿</div>
      <div class="my-posts-toolbar"><input id="myPostsSearch" type="search"></div>
      <div id="myPostsList"></div>
    </div>
  </main>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html">🏠ホーム</a>
      <a href="topics.html">🎯お題</a>
      <a href="notifications.html">🔔通知</a>
      <a href="settings.html">⚙️設定</a>
      <a href="about.html">📕概要</a>
    </nav>
  </footer>
  <a class="fab" href="post.html">🙏</a>

  <script src="script.js"></script>
  <script>
    function esc(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    // プロフィール即時描画
    function bootstrapProfileView(){
      if(typeof getProfile!=="function") return;
      const p=getProfile()||{};
      if(p.avatar) document.getElementById("profileAvatarShow").src=p.avatar;
      if(p.nickname) document.getElementById("profileNameShow").textContent=p.nickname;
      if(p.gender) document.getElementById("profileGenderShow").textContent="性別: "+p.gender;
      if(p.age) document.getElementById("profileAgeShow").textContent="年齢: "+p.age;
      if(p.bio) document.getElementById("profileBioShow").textContent="自己紹介: "+p.bio;
    }

    // フォロー欄描画拡張: 顔写真付き
    function renderFollowBoxesSafe(){
      if(typeof getFollowees!=="function") return;
      const users=JSON.parse(localStorage.getItem("users")||"{}");
      const auth=localStorage.getItem("authUserId");
      const me=users[auth]||{};

      const makeItem=(uid)=>{
        const prof=JSON.parse(localStorage.getItem("profile:"+uid)||"{}");
        const name=prof.nickname||uid;
        const avatar=prof.avatar||"images/default-avatar.png";
        return `<div class="follow-item"><img src="${esc(avatar)}" alt=""><span class="name">${esc(name)}</span><button onclick="unfollowUser('${uid}')">外す</button></div>`;
      };

      document.getElementById("followingList").innerHTML=(me.following||[]).map(makeItem).join("")||"なし";
      document.getElementById("followersList").innerHTML=(me.followers||[]).map(makeItem).join("")||"なし";

      document.getElementById("followStats").textContent=`フォロー ${me.following?.length||0} ・ フォロワー ${me.followers?.length||0}`;
    }

    document.addEventListener("DOMContentLoaded",()=>{
      bootstrapProfileView();
      if(typeof initProfileUI==="function") initProfileUI();
      renderFollowBoxesSafe();
      window.addEventListener("storage",(e)=>{
        if(!e.key) return;
        if(e.key.startsWith("profile:")||e.key==="users"){bootstrapProfileView();renderFollowBoxesSafe();}
      });
    });
  </script>
</body>
</html>
