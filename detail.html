<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - è©³ç´°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .stack { max-width: 860px; margin: 0 auto; padding: 16px; }
    .muted { color: #666; }
    .hidden-compat { display: none; }
    .detail-hero{
      border-radius:14px; min-height:160px; background:#f7f7f7 center/cover no-repeat;
      display:flex; align-items:flex-end; padding:12px;
    }
    .detail-title{ font-weight:800; font-size:18px; }
    .post-meta{ font-size:12px; color:#6b7280; margin-top:6px; display:flex; gap:6px; flex-wrap:wrap }
    .comment-item{ padding:10px 12px; border:1px solid #eee; border-radius:10px; margin:8px 0 }
    .comment-meta{ font-size:12px; color:#6b7280; margin-top:4px }
  </style>
  <script>
    /* åŒä¸€ã‚ªãƒªã‚¸ãƒ³å„ªå…ˆï¼ˆRenderæƒ³å®šï¼‰â†’ ç›¸å¯¾ â†’ ãƒ«ãƒ¼ãƒˆ */
    window.ZANGE_API_BASES = [
      location.origin.replace(/\/+$/,'') + '/api/posts',
      'api/posts',
      '/api/posts'
    ];
  </script>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main class="stack">
    <!-- äº’æ›ï¼šæ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½¿ã†æç”»å…ˆ -->
    <section id="detailCard" class="card"></section>
    <!-- æ–°æç”»å…ˆ -->
    <section id="detailContainer"></section>

    <!-- ã‚³ãƒ¡ãƒ³ãƒˆ -->
    <section class="comments">
      <h2>ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
      <div id="commentList" class="comment-list muted">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>

      <form id="commentForm" class="comment-form" autocomplete="off">
        <input type="hidden" id="commentUser" value="åŒ¿å" />
        <input type="hidden" id="cName" class="hidden-compat" value="åŒ¿å" />

        <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea id="commentText" required placeholder="ã‚ã‹ã‚‹ï¼ / è‡ªåˆ†ã‚‚ã‚„ã£ãŸğŸ˜‚ ãªã©"></textarea>
        <textarea id="cText" class="hidden-compat"></textarea>

        <button type="submit">æŠ•ç¨¿</button>
      </form>
      <p id="commentNote" class="muted" style="margin-top:8px;">â€» å…¬é–‹æŠ•ç¨¿ã®ã¿ã‚³ãƒ¡ãƒ³ãƒˆå¯èƒ½ï¼ˆMVPä»•æ§˜ï¼‰</p>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
    function fmtDate(iso){
      if (typeof formatDate === 'function') return formatDate(iso);
      try {
        const d = new Date(iso||'');
        if (isNaN(d)) return '';
        const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
        const hh=('0'+d.getHours()).slice(-2), mm=('0'+d.getMinutes()).slice(-2);
        return `${y}/${m}/${dd} ${hh}:${mm}`;
      } catch { return iso || ''; }
    }
    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function q(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || '';
    }
    async function fetchJsonWithFallback(urls, init){
      let last;
      for (const u of urls){
        try{
          const url = u + (u.includes('?')?'&':'?') + '_t='+Date.now();
          const res = await fetch(url, Object.assign({ cache:'no-store', credentials:'omit' }, init||{}));
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ last = e; }
      }
      throw last || new Error('fetch fail');
    }

    /* ===== Posts API ===== */
    const API = {
      async list(){ return await fetchJsonWithFallback(window.ZANGE_API_BASES, { method:'GET' }); }
    };

    /* ===== Comments API ãƒ™ãƒ¼ã‚¹URLï¼ˆposts ã¨åŒæ§˜ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ§‹æˆï¼‰ ===== */
    const COMMENTS_BASES = (window.ZANGE_API_BASES || [])
      .map(u => u.replace(/\/posts(\?.*)?$/,'/comments'))
      .concat([
        location.origin.replace(/\/+$/,'') + '/api/comments',
        'api/comments',
        '/api/comments'
      ])
      .filter(Boolean);

    async function listCommentsFromServer(postId){
      const qs = `?postId=${encodeURIComponent(postId)}`;
      return await fetchJsonWithFallback(COMMENTS_BASES.map(u=>u+qs), { method:'GET' });
    }
    async function addCommentToServer(postId, user, text){
      const body = JSON.stringify({ postId, user, text });
      // POST ã¯å…¨BASEã‚’é †ã«è©¦ã™
      let last;
      for (const base of COMMENTS_BASES){
        try{
          const u = base + (base.includes('?')?'&':'?') + '_t='+Date.now();
          const res = await fetch(u, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body,
            cache:'no-store',
            credentials:'omit'
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ last = e; }
      }
      throw last || new Error('post comment failed');
    }

    /* ===== localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¾“æ¥äº’æ›ã®ãŸã‚æ®‹ã™ï¼‰ ===== */
    function commentsKey(id){ return `zange_comments_${id}`; }
    function loadCommentsLocal(id){
      try { return JSON.parse(localStorage.getItem(commentsKey(id))||'[]'); }
      catch { return []; }
    }
    function saveCommentLocal(id, item){
      const arr = loadCommentsLocal(id);
      arr.push(item);
      localStorage.setItem(commentsKey(id), JSON.stringify(arr));
    }

    /* ===== ã‚³ãƒ¡ãƒ³ãƒˆæç”» ===== */
    function renderCommentsList(items){
      const listEl = document.getElementById('commentList');
      listEl.innerHTML = '';
      if (!items.length){
        listEl.classList.add('muted');
        listEl.textContent = 'ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }
      listEl.classList.remove('muted');
      items.forEach(c=>{
        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `
          <div>${esc(c.text)}</div>
          <div class="comment-meta">by ${esc(c.user||'åŒ¿å')} ãƒ» ${fmtDate(c.createdAt)}</div>
        `;
        listEl.appendChild(div);
      });
    }

    async function renderComments(postId){
      // 1) ã‚µãƒ¼ãƒãƒ¼å„ªå…ˆ
      try{
        const server = await listCommentsFromServer(postId); // ASCã§è¿”ã™å®Ÿè£…
        renderCommentsList(server);
        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚åŒæœŸã—ã¦ãŠãï¼ˆä»»æ„ï¼‰
        try { localStorage.setItem(commentsKey(postId), JSON.stringify(server)); } catch {}
        return;
      }catch(e){
        // 2) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šlocalStorage
        const local = loadCommentsLocal(postId).sort((a,b)=>String(a.createdAt||'').localeCompare(String(b.createdAt||'')));
        renderCommentsList(local);
      }
    }

    /* ===== è©³ç´°æç”» ===== */
    function renderDetail(post){
      const old = document.getElementById('detailCard');
      if (old){
        old.innerHTML = `
          <div class="detail-hero" style="${post.bg ? `background-image:url('${esc(post.bg.startsWith('http')?post.bg:('/images/'+post.bg))}')` : ''}">
            <div class="detail-title">${esc(post.text||'')}</div>
          </div>
          <div class="post-meta">
            <span>by ${esc(post.author||'åŒ¿å')}</span>
            ${post.target?`<span class="pill">å¯¾è±¡: ${esc(post.target)}</span>`:''}
            ${post.tag?`<span class="pill">ã‚¿ã‚°: ${esc(post.tag)}</span>`:''}
            <span>${fmtDate(post.createdAt||post.created_at||post.date)}</span>
            ${post.scope?`<span class="pill">å…¬é–‹: ${esc(post.scope)}</span>`:''}
          </div>
        `;
      }

      const wrap = document.getElementById('detailContainer');
      if (wrap){
        const card = document.createElement('article');
        card.className = 'card zange-post';
        card.innerHTML = `
          <div class="post-body" style="font-size:16px; line-height:1.8">${esc((post.text||'')).replace(/\n/g,'<br>')}</div>
          <div class="post-meta" style="margin-top:8px">
            <span class="post-author">by ${esc(post.author||'åŒ¿å')}</span>
            ${post.target?`<span class="pill">å¯¾è±¡: ${esc(post.target)}</span>`:''}
            ${post.tag?`<span class="pill">ã‚¿ã‚°: ${esc(post.tag)}</span>`:''}
            ${post.scope?`<span class="pill">å…¬é–‹: ${esc(post.scope)}</span>`:''}
            <span>ãƒ»${fmtDate(post.createdAt||post.created_at||post.date)}</span>
            <button class="post-stamp-btn" type="button" data-id="${post.id||''}" aria-label="ã‚¹ã‚¿ãƒ³ãƒ—ã™ã‚‹">ğŸ‘</button>
          </div>
        `;
        wrap.innerHTML = '';
        wrap.appendChild(card);
      }
    }

    /* ===== å…¥åŠ›ãƒŸãƒ©ãƒ¼ï¼ˆäº’æ›ç¶­æŒï¼‰ ===== */
    (function mirrorSetup(){
      const nameOld = document.getElementById('commentUser');
      const nameNew = document.getElementById('cName');
      const textOld = document.getElementById('commentText');
      const textNew = document.getElementById('cText');
      function mirror(src, dst){ dst.value = src.value; }

      if (nameOld && nameNew) {
        nameOld.addEventListener('input', ()=> mirror(nameOld, nameNew));
        nameNew.addEventListener('input', ()=> mirror(nameNew, nameOld));
        if (!nameNew.value) nameNew.value = nameOld.value || '';
      }
      if (textOld && textNew) {
        textOld.addEventListener('input', ()=> mirror(textOld, textNew));
        textNew.addEventListener('input', ()=> mirror(textNew, textOld));
        if (!textNew.value) textNew.value = textOld.value || '';
      }
    })();

    /* ===== ãƒ¡ã‚¤ãƒ³ ===== */
    (async function main(){
      const idParam = q('id') || q('postId');
      const detailCard = document.getElementById('detailCard');
      const commentForm = document.getElementById('commentForm');
      const commentNote = document.getElementById('commentNote');

      if (!idParam){
        detailCard.innerHTML = '<div class="muted">æŠ•ç¨¿IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
        commentForm.style.display = 'none';
        commentNote.textContent = 'â€» æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã§ãã¾ã›ã‚“ã€‚';
        return;
      }

      let posts = [];
      try{
        posts = await API.list();
      }catch(e){
        detailCard.innerHTML = `<div class="muted">æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${e?.message||'ã‚¨ãƒ©ãƒ¼'}ï¼‰ã€‚</div>`;
        commentForm.style.display = 'none';
        commentNote.textContent = 'â€» æŠ•ç¨¿ãŒå–å¾—ã§ããªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã§ãã¾ã›ã‚“ã€‚';
        return;
      }

      const post = posts.find(p => String(p.id) === String(idParam));
      if (!post){
        detailCard.innerHTML = '<div class="muted">è©²å½“ã®æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        commentForm.style.display = 'none';
        commentNote.textContent = 'â€» æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã§ãã¾ã›ã‚“ã€‚';
        return;
      }

      renderDetail(post);

      const isPublic = (post.scope || 'public') === 'public';
      if (!isPublic){
        commentForm.style.display = 'none';
        commentNote.textContent = 'â€» éå…¬é–‹æŠ•ç¨¿ã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã§ãã¾ã›ã‚“ã€‚';
      }

      // åˆæœŸè¡¨ç¤ºï¼šã‚µãƒ¼ãƒãƒ¼å„ªå…ˆ â†’ å¤±æ•—æ™‚ãƒ­ãƒ¼ã‚«ãƒ«
      await renderComments(post.id);

      // é€ä¿¡
      commentForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if (!isPublic) return;

        const user = (document.getElementById('commentUser')?.value || 'åŒ¿å').trim();
        const text = (document.getElementById('commentText')?.value || '').trim();
        if (!text){ alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

        // 1) ã¾ãšã‚µãƒ¼ãƒãƒ¼ã¸
        try{
          await addCommentToServer(post.id, user || 'åŒ¿å', text);
        }catch(e){
          // 2) ã‚µãƒ¼ãƒãƒ¼å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          console.warn('comment POST failed, fallback to local:', e?.message || e);
          saveCommentLocal(post.id, { user: user||'åŒ¿å', text, createdAt: new Date().toISOString() });
        }

        // å…¥åŠ›ã‚¯ãƒªã‚¢ & å†èª­è¾¼ï¼ˆã‚µãƒ¼ãƒãƒ¼å„ªå…ˆï¼‰
        (document.getElementById('commentText')||{}).value = '';
        await renderComments(post.id);
      });
    })();
  </script>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ã‚¿ãƒ–ãƒãƒ¼ -->
  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">ğŸ </span><span class="label">ãƒ›ãƒ¼ãƒ </span></a>
      <a href="topics.html"><span class="icon">ğŸ¯</span><span class="label">ãŠé¡Œ</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">ğŸ””</span><span id="notifBadge" class="notif-badge" aria-label="æœªèª­é€šçŸ¥æ•°"></span></span>
        <span class="label">é€šçŸ¥</span>
      </a>
      <a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">è¨­å®š</span></a>
      <a href="about.html"><span class="icon">ğŸ“•</span><span class="label">æ¦‚è¦</span></a>
    </nav>
  </footer>

  <a class="fab" href="post.html"><span class="emoji">ğŸ™</span></a>
</body>
</html>
