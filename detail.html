<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>zange - 詳細</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .stack { max-width: 860px; margin: 0 auto; padding: 16px; }
    .muted { color: #666; }
    .hidden-compat { display: none; }
    .detail-hero{
      border-radius:14px; min-height:160px; background:#f7f7f7 center/cover no-repeat;
      display:flex; align-items:flex-end; padding:12px;
    }
    .detail-title{ font-weight:800; font-size:18px; }
    .post-meta{ font-size:12px; color:#6b7280; margin-top:6px; display:flex; gap:6px; flex-wrap:wrap }
    .comment-item{ padding:10px 12px; border:1px solid #eee; border-radius:10px; margin:8px 0 }
    .comment-meta{ font-size:12px; color:#6b7280; margin-top:4px }
  </style>
  <script>
    window.ZANGE_API_BASES = [
      location.origin.replace(/\/+$/,'') + '/api/posts',
      'api/posts',
      '/api/posts'
    ];
  </script>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h1><a href="index.html" style="text-decoration:none; color:inherit;">zange</a></h1>
      <!-- ログイン状態 -->
      <span id="currentUserIcon"></span>
    </div>
  </header>

  <main class="stack">
    <section id="detailCard" class="card"></section>
    <section id="detailContainer"></section>

    <!-- コメント -->
    <section class="comments">
      <h2>コメント</h2>
      <div id="commentList" class="comment-list muted">まだコメントはありません。</div>

      <form id="commentForm" class="comment-form" autocomplete="off">
        <!-- userはサーバー側sessionから自動補完 -->
        <label>コメント</label>
        <textarea id="commentText" required placeholder="わかる！ / 自分もやった😂 など"></textarea>
        <button type="submit">投稿</button>
      </form>
      <p id="commentNote" class="muted" style="margin-top:8px;">※ 公開投稿のみコメント可能（MVP仕様）</p>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    /* ===== ユーティリティ ===== */
    function fmtDate(iso){
      try {
        const d = new Date(iso||'');
        if (isNaN(d)) return '';
        return `${d.getFullYear()}/${('0'+(d.getMonth()+1)).slice(-2)}/${('0'+d.getDate()).slice(-2)} ${('0'+d.getHours()).slice(-2)}:${('0'+d.getMinutes()).slice(-2)}`;
      } catch { return iso || ''; }
    }
    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
    function q(name){ return new URL(location.href).searchParams.get(name) || ''; }

    async function fetchJsonWithFallback(urls, init){
      let last;
      for (const u of urls){
        try{
          const url = u + (u.includes('?')?'&':'?') + '_t='+Date.now();
          const res = await fetch(url, Object.assign({ cache:'no-store', credentials:'omit' }, init||{}));
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ last = e; }
      }
      throw last || new Error('fetch fail');
    }

    const API = {
      async list(){ return await fetchJsonWithFallback(window.ZANGE_API_BASES, { method:'GET' }); }
    };

    const COMMENTS_BASES = (window.ZANGE_API_BASES || [])
      .map(u => u.replace(/\/posts(\?.*)?$/,'/comments'))
      .concat([
        location.origin.replace(/\/+$/,'') + '/api/comments',
        'api/comments',
        '/api/comments'
      ]);

    async function listCommentsFromServer(postId){
      const qs = `?postId=${encodeURIComponent(postId)}`;
      return await fetchJsonWithFallback(COMMENTS_BASES.map(u=>u+qs), { method:'GET' });
    }
    async function addCommentToServer(postId, text){
      const body = JSON.stringify({ postId, text }); // userは送らずサーバーがsessionから補完
      let last;
      for (const base of COMMENTS_BASES){
        try{
          const u = base + (base.includes('?')?'&':'?') + '_t='+Date.now();
          const res = await fetch(u, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body,
            cache:'no-store',
            credentials:'include'
          });
          if (!res.ok) throw new Error('HTTP '+res.status);
          return await res.json();
        }catch(e){ last = e; }
      }
      throw last || new Error('post comment failed');
    }

    function commentsKey(id){ return `zange_comments_${id}`; }
    function loadCommentsLocal(id){ try { return JSON.parse(localStorage.getItem(commentsKey(id))||'[]'); } catch { return []; } }
    function saveCommentLocal(id, item){
      const arr = loadCommentsLocal(id);
      arr.push(item);
      localStorage.setItem(commentsKey(id), JSON.stringify(arr));
    }

    function renderCommentsList(items){
      const listEl = document.getElementById('commentList');
      listEl.innerHTML = '';
      if (!items.length){ listEl.classList.add('muted'); listEl.textContent = 'まだコメントはありません。'; return; }
      listEl.classList.remove('muted');
      items.forEach(c=>{
        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `<div>${esc(c.text)}</div><div class="comment-meta">by ${esc(c.user||'匿名')} ・ ${fmtDate(c.createdAt)}</div>`;
        listEl.appendChild(div);
      });
    }

    async function renderComments(postId){
      try{
        const server = await listCommentsFromServer(postId);
        renderCommentsList(server);
        localStorage.setItem(commentsKey(postId), JSON.stringify(server));
        return;
      }catch{ renderCommentsList(loadCommentsLocal(postId)); }
    }

    function renderDetail(post){
      const wrap = document.getElementById('detailContainer');
      if (!wrap) return;
      const card = document.createElement('article');
      card.className = 'card zange-post';
      card.innerHTML = `
        <div class="post-body" style="font-size:16px; line-height:1.8">${esc((post.text||'')).replace(/\n/g,'<br>')}</div>
        <div class="post-meta" style="margin-top:8px">
          <span class="post-author">by ${esc(post.author||'匿名')}</span>
          ${post.target?`<span class="pill">対象: ${esc(post.target)}</span>`:''}
          ${post.tag?`<span class="pill">タグ: ${esc(post.tag)}</span>`:''}
          ${post.scope?`<span class="pill">公開: ${esc(post.scope)}</span>`:''}
          <span>・${fmtDate(post.createdAt||post.created_at||post.date)}</span>
          <button class="post-stamp-btn" type="button" data-id="${post.id||''}" aria-label="スタンプする">👏</button>
        </div>`;
      wrap.innerHTML = '';
      wrap.appendChild(card);
    }

    (async function main(){
      const idParam = q('id') || q('postId');
      const detailCard = document.getElementById('detailCard');
      const commentForm = document.getElementById('commentForm');
      const commentNote = document.getElementById('commentNote');

      if (!idParam){ detailCard.innerHTML = '<div class="muted">投稿IDが指定されていません。</div>'; commentForm.style.display = 'none'; return; }

      let posts = [];
      try{ posts = await API.list(); }
      catch(e){ detailCard.innerHTML = `<div class="muted">投稿の取得に失敗しました。</div>`; commentForm.style.display = 'none'; return; }

      const post = posts.find(p => String(p.id) === String(idParam));
      if (!post){ detailCard.innerHTML = '<div class="muted">該当の投稿が見つかりません。</div>'; commentForm.style.display = 'none'; return; }

      renderDetail(post);
      if ((post.scope||'public') !== 'public'){ commentForm.style.display='none'; commentNote.textContent='※ 非公開投稿のためコメントはできません。'; }

      await renderComments(post.id);

      commentForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = (document.getElementById('commentText')?.value || '').trim();
        if (!text){ alert('コメントを入力してください'); return; }
        try{ await addCommentToServer(post.id, text); }
        catch(e){ saveCommentLocal(post.id, { text, createdAt: new Date().toISOString() }); }
        document.getElementById('commentText').value = '';
        await renderComments(post.id);
      });
    })();

    // ===== ログイン状態の表示 =====
    async function renderUserIcon(){
      const box = document.getElementById("currentUserIcon");
      if (!box) return;
      try{
        const res = await fetch("/api/me",{credentials:"include",cache:"no-store"});
        const data = await res.json();
        if (data.ok && data.user){
          const name = data.user.nickname || data.user.email;
          box.innerHTML = `
            <span style="display:inline-flex;align-items:center;gap:8px;">
              <span class="pill" style="padding:6px 10px;border-radius:999px;background:#f1f5f9;">👤 ${esc(name)}</span>
              <button id="logoutBtn" style="padding:6px 10px;border-radius:10px;border:1px solid #e6e6e6;background:#fff;cursor:pointer">ログアウト</button>
            </span>`;
          document.getElementById("logoutBtn")?.addEventListener("click", async()=>{
            await fetch("/api/logout",{method:"POST",credentials:"include"});
            renderUserIcon();
          });
        } else { box.innerHTML = `<a href="login.html">ログイン</a>`; }
      }catch{ box.innerHTML = `<a href="login.html">ログイン</a>`; }
    }
    document.addEventListener("DOMContentLoaded", renderUserIcon);
  </script>

  <footer class="mobile-tabbar">
    <nav>
      <a href="index.html"><span class="icon">🏠</span><span class="label">ホーム</span></a>
      <a href="topics.html"><span class="icon">🎯</span><span class="label">お題</span></a>
      <a href="notifications.html" class="nav-link nav-bell">
        <span class="icon-row"><span class="icon">🔔</span><span id="notifBadge" class="notif-badge" aria-label="未読通知数"></span></span>
        <span class="label">通知</span>
      </a>
      <a href="settings.html"><span class="icon">⚙️</span><span class="label">設定</span></a>
      <a href="about.html"><span class="icon">📕</span><span class="label">概要</span></a>
    </nav>
  </footer>
  <a class="fab" href="post.html"><span class="emoji">🙏</span></a>
</body>
</html>
