<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>新規登録 - zange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css" />
  <style>
    main{max-width:520px;margin:24px auto;padding:16px}
    .card{padding:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    input{padding:10px;border:1px solid #e6e6e6;border-radius:10px}
    button{padding:12px 14px;border-radius:999px;border:0;background:#111;color:#fff;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .msg{margin-top:8px;font-size:14px}
    .msg.err{color:#b91c1c}
    .msg.ok{color:#065f46}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <div class="h-left"><a class="logo" href="index.html">zange</a></div>
      <div class="h-right"><div id="currentUserIcon" class="user-ico"></div></div>
    </div>
  </header>

  <main>
    <div class="card">
      <form id="signupForm" novalidate>
        <div class="field">
          <label for="suEmail">メールアドレス</label>
          <input id="suEmail" type="email" placeholder="you@example.com" required autocomplete="email">
        </div>

        <div class="field">
          <label for="suPass">パスワード</label>
          <input id="suPass" type="password" placeholder="8文字以上が目安" minlength="8" required autocomplete="new-password">
        </div>

        <div class="field">
          <label for="nickname">ニックネーム</label>
          <input type="text" id="nickname" name="nickname" placeholder="zange太郎" required>
        </div>

        <button type="submit" id="signupSubmit" class="btn primary">登録する</button>
        <div id="signupMsg" class="msg" role="status" aria-live="polite"></div>
      </form>

      <p style="margin-top:10px"><a href="login.html">既にアカウントをお持ちの方はこちら</a></p>
    </div>

    <div class="legal-links" style="margin-top:16px; text-align:center; font-size:13px;">
      <a href="about.html" style="margin:0 8px; text-decoration:none; color:#555;">サービス概要</a> |
      <a href="terms.html" style="margin:0 8px; text-decoration:none; color:#555;">利用規約</a> |
      <a href="privacy.html" style="margin:0 8px; text-decoration:none; color:#555;">プライバシーポリシー</a>
      <p class="copyright">© 2025 zange（テスト公開中）</p>
    </div>
  </main>

  <script>
    function setMsg(el, text, ok=false){
      el.textContent = text || '';
      el.className = 'msg ' + (ok ? 'ok' : 'err');
    }
    async function postJSON(url, data){
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data),
        credentials: 'include' // ← セッションCookie受け取り
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || json.ok === false){
        throw new Error(json.error || ('HTTP ' + res.status));
      }
      return json;
    }

    document.getElementById('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('suEmail').value.trim();
      const password = document.getElementById('suPass').value.trim();
      const nickname = document.getElementById('nickname').value.trim();
      const btn = document.getElementById('signupSubmit');
      const msg = document.getElementById('signupMsg');

      if (!email || !password || !nickname){
        setMsg(msg, 'メール・パスワード・ニックネームを入力してください');
        return;
      }
      if (password.length < 8){
        setMsg(msg, 'パスワードは8文字以上を入力してください');
        return;
      }

      btn.disabled = true; setMsg(msg, '登録中…', true);
      try{
        await postJSON('/api/signup', { email, password, nickname });
        // 登録と同時にログイン状態になる → 確認してから遷移
        const meRes = await fetch('/api/me', { credentials:'include' });
        const me = await meRes.json().catch(()=>null);
        if (me && me.ok) {
          localStorage.setItem('zange_user', JSON.stringify(me.user));
        }
        location.href = 'index.html';
      }catch(err){
        setMsg(msg, err.message || '登録に失敗しました');
      }finally{
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
